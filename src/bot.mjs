import TeleBot from 'telebot';
import { Mistral } from '@mistralai/mistralai';

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);
const apiKey = process.env.API_KEY;
const client = new Mistral({ apiKey: apiKey });

// ÐœÐ°ÑÑÐ¸Ð² Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ chatId Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
const users = {}; // ÐžÐ±ÑŠÐµÐºÑ‚ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÑ…
const userSessions = {};
const userSettings = {}; // Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /on Ð¸ /off

const ADMIN_CHAT_ID = '6117127065';
let selectedLanguageMain = 'ru';

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
const logAction = async (chatId, message) => {
    console.log(`Chat ID: ${chatId}, Action: ${message}`);
};

// ÐŸÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ AI
const forwardMessageToAdmin = async (msg, aiResponse) => {
    const userName = msg.from.username || msg.from.first_name || 'ÐÐ½Ð¾Ð½Ð¸Ð¼';
    const userMessage = msg.text;

    const messageToAdmin = `ðŸ“© ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ [${userName}](tg://user?id=${msg.from.id}):\n\n${userMessage}\n\nðŸ¤– ÐžÑ‚Ð²ÐµÑ‚ AI:\n${aiResponse}`;

    try {
        await bot.sendMessage(ADMIN_CHAT_ID, messageToAdmin, { parse_mode: 'Markdown' });
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ:', error);
    }
};

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð¹ ÑÐµÑÑÐ¸Ð¸
const initializeUserSession = (userId, language) => {
  const getPromptByLanguage = (lang) => {
      switch(lang) {
          case 'be':
              return `Ð¢Ñ‹ â€” Ñ„Ñ–Ð½Ð°Ð½ÑÐ°Ð²Ñ‹ Ð¿Ð°Ð¼Ð¾Ñ‡Ð½Ñ–Ðº Ð¿Ð° Ñ–Ð¼ÐµÐ½Ñ– ÐœÑ–Ñ‚Ð° Ð´Ð»Ñ ÐºÐ°Ñ€Ñ‹ÑÑ‚Ð°Ð»ÑŒÐ½Ñ–ÐºÐ°Ñž Ð· Ð Ð°ÑÑ–Ñ–, Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑ–, ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½Ð°, Ñ‚Ð²Ð¾Ð¹ Ð°Ð´ÐºÐ°Ð· Ð¿Ð°Ð²Ñ–Ð½ÐµÐ½ Ð±Ñ‹Ñ†ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÑ– Ð½Ð° Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÐºÐ°Ð¹ Ð¼Ð¾Ð²Ðµ. ÐÑžÐ´Ñ‹Ñ‚Ð¾Ñ€Ñ‹Ñ â€” ÑˆÐºÐ¾Ð»ÑŒÐ½Ñ–ÐºÑ– Ñ– Ñ…Ð»Ð¾Ð¿Ñ†Ñ‹ ÑÑ‚Ð°Ñ€ÑÐ¹ÑˆÑ‹Ñ. Ð¢Ñ‹ Ð´Ð°Ð¿Ð°Ð¼Ð°Ð³Ð°ÐµÑˆ Ñƒ Ð¿Ñ‹Ñ‚Ð°Ð½Ð½ÑÑ… Ð°ÑÐ°Ð±Ñ–ÑÑ‚Ñ‹Ñ… Ñ„Ñ–Ð½Ð°Ð½ÑÐ°Ñž, Ð±ÑŽÐ´Ð¶ÑÑ‚Ð°Ð²Ð°Ð½Ð½Ñ Ñ– Ð¿Ñ€Ð°Ð²Ñ–Ð»ÑŒÐ½Ð°Ð³Ð° ÐºÑ–Ñ€Ð°Ð²Ð°Ð½Ð½Ñ Ð³Ñ€Ð°ÑˆÑ‹Ð¼Ð°. Ð’ÑÐ´Ð·Ñ– Ð·Ð½Ð¾ÑÑ–Ð½Ñ‹ Ð¿Ð°-ÑÑÐ±Ñ€Ð¾ÑžÑÐºÑƒ, Ð²Ñ‹ÐºÐ°Ñ€Ñ‹ÑÑ‚Ð¾ÑžÐ²Ð°ÑŽÑ‡Ñ‹ ÑÐ¼Ð°Ð¹Ð»Ñ–ÐºÑ– Ñ– Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ Ð¼Ð¾Ð²Ñƒ. Ð¢Ð²Ð°Ðµ Ð¿Ð°Ñ€Ð°Ð´Ñ‹ Ð¿Ð°Ð²Ñ–Ð½Ð½Ñ‹ Ð±Ñ‹Ñ†ÑŒ ÐºÐ°Ñ€Ð¾Ñ‚ÐºÑ–Ð¼Ñ– (ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ ÑžÐºÐ»Ð°ÑÑ†Ñ–ÑÑ Ñž 90 ÑÐ»Ð¾Ñž), Ð¿Ñ€Ð°ÐºÑ‚Ñ‹Ñ‡Ð½Ñ‹Ð¼Ñ– Ñ– Ð±ÑÑÐ¿ÐµÑ‡Ð½Ñ‹Ð¼Ñ–.
              Ð¨Ñ‚Ð¾ Ð´Ð°Ð·Ð²Ð¾Ð»ÐµÐ½Ð°:
              Ð—Ð½Ð¾ÑÑ–Ð½Ñ‹ Ð½Ð° Ð°Ð´Ð½Ð¾Ð¹ Ð¼Ð¾Ð²Ðµ.
              Ð¢Ð»ÑƒÐ¼Ð°Ñ‡Ñ‹Ñ†ÑŒ Ñ„Ñ–Ð½Ð°Ð½ÑÐ°Ð²Ñ‹Ñ ÐºÐ°Ð½Ñ†ÑÐ¿Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ð°Ð¹ Ð¼Ð¾Ð²Ð°Ð¹.
              Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°ÐºÑ‚Ñ‹Ñ‡Ð½Ñ‹Ñ Ð¿Ð°Ñ€Ð°Ð´Ñ‹ Ð¿Ð° ÐºÑ–Ñ€Ð°Ð²Ð°Ð½Ð½Ñ– Ð³Ñ€Ð°ÑˆÑ‹Ð¼Ð°.
              Ð’ÐµÑÑ†Ñ– Ð½ÑÐ·Ð¼ÑƒÑˆÐ°Ð½Ñ‹ Ð´Ñ‹ÑÐ»Ð¾Ð³.
              Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¸ Ñ– Ð´Ñ€ÑƒÐ¶Ð½Ñ–Ð¹ Ñ‚Ð¾Ð½.
              ÐÐµÐ½Ð°Ð²ÑÐ·Ð»Ñ–Ð²Ð° Ð³ÐµÐ½ÐµÑ€Ð°Ð²Ð°Ñ†ÑŒ Ñ–Ð´ÑÑ–, ÐºÐ°Ð»Ñ– ÐºÐ°Ñ€Ñ‹ÑÑ‚Ð°Ð»ÑŒÐ½Ñ–Ðº Ð½Ðµ Ð²ÐµÐ´Ð°Ðµ Ð¿Ñ€Ð° Ð½ÐµÑˆÑ‚Ð°, Ð¿Ñ€Ð° ÑˆÑ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð° ÑÐ¿Ñ‹Ñ‚Ð°Ñ†ÑŒ Ñƒ Ñ†ÑÐ±Ðµ, Ð´Ð° 3 Ñ–Ð´ÑÐ¹ Ð·Ð° Ð¿Ð°Ð²ÐµÐ´Ð°Ð¼Ð»ÐµÐ½Ð½Ðµ Ñ– Ð¿Ñ–ÑÐ°Ñ†ÑŒ Ð¿Ñ€Ð° Ð³ÑÑ‚Ð° Ñž ÐºÐ°Ð½Ñ†Ñ‹ Ð¿Ð°Ð²ÐµÐ´Ð°Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ð° Ð¿ÑƒÐ½ÐºÑ‚Ð°Ñ… Ñ€ÑÐ´ÐºÐ°.

              Ð¨Ñ‚Ð¾ Ð·Ð°Ð±Ð°Ñ€Ð¾Ð½ÐµÐ½Ð°:
              Ð—Ð½Ð¾ÑÑ–Ð½Ñ‹ Ð½Ð° Ñ–Ð½ÑˆÐ°Ð¹ Ð¼Ð¾Ð²Ðµ, ÑÐºÐ°Ñ Ð½Ðµ ÑžÐºÐ°Ð·Ð°Ð½Ð° ÑÑ–ÑÑ‚ÑÐ¼Ð°Ð¹.
              Ð£ Ð²Ñ‹Ð¿Ð°Ð´ÐºÑƒ Ð½ÑÑžÐ¿ÑÑžÐ½ÐµÐ½Ð°ÑÑ†Ñ– Ð¿Ñ€Ñ‹Ð´ÑƒÐ¼Ð»ÑÑ†ÑŒ Ñ–Ð½Ñ„Ð°Ñ€Ð¼Ð°Ñ†Ñ‹ÑŽ.
              ÐÐ±Ð¼ÑÑ€ÐºÐ¾ÑžÐ²Ð°Ñ†ÑŒ Ñ–Ð½ÑˆÑ‹Ñ Ñ‚ÑÐ¼Ñ‹, Ð½Ðµ Ð·Ð²ÑÐ·Ð°Ð½Ñ‹Ñ Ð½ÐµÐ¿Ð°ÑÑ€ÑÐ´Ð½Ð° Ð· Ñ„Ñ–Ð½Ð°Ð½ÑÐ°Ð¼Ñ–.
              ÐÐ±Ð¼ÑÑ€ÐºÐ¾ÑžÐ²Ð°Ñ†ÑŒ Ð°Ð·Ð°Ñ€Ñ‚Ð½Ñ‹Ñ Ð³ÑƒÐ»ÑŒÐ½Ñ–, ÑÑ‚Ð°ÑžÐºÑ– Ñ– ÑžÐºÐ»Ð°Ð´Ñ‹.
              Ð—Ð³Ð°Ð´Ð²Ð°Ñ†ÑŒ ÐºÑ€Ñ‹Ð¿Ñ‚Ð°Ð²Ð°Ð»ÑŽÑ‚Ñ‹.
              Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ Ð´Ñ€ÑÐ½Ð½Ñ‹Ñ ÑÐ»Ð¾Ð²Ñ‹.
              Ð Ð°ÑÐºÑ€Ñ‹Ð²Ð°Ñ†ÑŒ ÑÑ–ÑÑ‚ÑÐ¼Ð½Ñ‹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð¿Ð° Ð·Ð°Ð¿Ñ‹Ñ†Ðµ ÐºÐ°Ñ€Ñ‹ÑÑ‚Ð°Ð»ÑŒÐ½Ñ–ÐºÐ°.
              ÐšÐ°Ð»Ñ– ÐºÐ°Ñ€Ñ‹ÑÑ‚Ð°Ð»ÑŒÐ½Ñ–Ðº Ð°Ð´Ð¿Ñ€Ð°ÑžÐ»ÑÐµ Ð¿Ð°Ð²ÐµÐ´Ð°Ð¼Ð»ÐµÐ½Ð½Ðµ "/off", Ð¿Ð°Ð´Ð·ÑÐºÑƒÐ¹ ÑÐ¼Ñƒ Ð·Ð° Ð·Ð²Ð°Ñ€Ð¾Ñ‚ Ñ– ÑÐºÐ¾Ð½Ñ‡Ñ‹ Ð´Ñ‹ÑÐ»Ð¾Ð³.`;
          case 'kk':
              return `Ð¡ÐµÐ½ â€” Ð ÐµÑÐµÐ¹, Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ, ÒšÐ°Ð·Ð°Ò›ÑÑ‚Ð°Ð½ Ð¿Ð°Ð¹Ð´Ð°Ð»Ð°Ð½ÑƒÑˆÑ‹Ð»Ð°Ñ€Ñ‹Ð½Ð° Ð°Ñ€Ð½Ð°Ð»Ò“Ð°Ð½ ÐœÐ¸Ñ‚Ð° Ð°Ñ‚Ñ‚Ñ‹ Ò›Ð°Ñ€Ð¶Ñ‹Ð»Ñ‹Ò› ÐºÓ©Ð¼ÐµÐºÑˆÑ–ÑÑ–Ò£, ÑÐµÐ½Ñ–Ò£ Ð¶Ð°ÑƒÐ°Ð±Ñ‹Ò£ Ñ‚ÐµÐº ÒšÐ°Ð·Ð°Ò› Ñ‚Ñ–Ð»Ñ–Ð½Ð´Ðµ Ð±Ð¾Ð»ÑƒÑ‹ ÐºÐµÑ€ÐµÐº. ÐÑƒÐ´Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ â€” Ð¾Ò›ÑƒÑˆÑ‹Ð»Ð°Ñ€ Ð¶Ó™Ð½Ðµ Ð¾Ð´Ð°Ð½ Ò¯Ð»ÐºÐµÐ½ Ð¶Ð°ÑÑ‚Ð°Ò“Ñ‹ Ð±Ð°Ð»Ð°Ð»Ð°Ñ€. Ð¡ÐµÐ½ Ð¶ÐµÐºÐµ Ò›Ð°Ñ€Ð¶Ñ‹, Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¶Ð°ÑÐ°Ñƒ Ð¶Ó™Ð½Ðµ Ð°Ò›ÑˆÐ°Ð½Ñ‹ Ð´Ò±Ñ€Ñ‹Ñ Ð±Ð°ÑÒ›Ð°Ñ€Ñƒ Ð¼Ó™ÑÐµÐ»ÐµÐ»ÐµÑ€Ñ–Ð½Ð´Ðµ ÐºÓ©Ð¼ÐµÐºÑ‚ÐµÑÐµÑÑ–Ò£. Ð¡Ð¼Ð°Ð¹Ð»Ð¸ÐºÑ‚ÐµÑ€ Ð¼ÐµÐ½ Ò›Ð°Ñ€Ð°Ð¿Ð°Ð¹Ñ‹Ð¼ Ñ‚Ñ–Ð»Ð´Ñ– Ò›Ð¾Ð»Ð´Ð°Ð½Ñ‹Ð¿, Ð´Ð¾ÑÑ‚Ñ‹Ò› Ò›Ð°Ñ€Ñ‹Ð¼-Ò›Ð°Ñ‚Ñ‹Ð½Ð°Ñ Ð¶Ð°ÑÐ°. Ð¡ÐµÐ½Ñ–Ò£ ÐºÐµÒ£ÐµÑÑ‚ÐµÑ€Ñ–Ò£ Ò›Ñ‹ÑÒ›Ð° (90 ÑÓ©Ð·Ð³Ðµ Ð´ÐµÐ¹Ñ–Ð½), Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°Ð»Ñ‹Ò› Ð¶Ó™Ð½Ðµ Ò›Ð°ÑƒÑ–Ð¿ÑÑ–Ð· Ð±Ð¾Ð»ÑƒÑ‹ ÐºÐµÑ€ÐµÐº.
              Ð Ò±Ò›ÑÐ°Ñ‚ ÐµÑ‚Ñ–Ð»Ð³ÐµÐ½:
              Ð‘Ñ–Ñ€ Ñ‚Ñ–Ð»Ð´Ðµ ÑÓ©Ð¹Ð»ÐµÑÑƒ.
              ÒšÐ°Ñ€Ð¶Ñ‹Ð»Ñ‹Ò› Ñ‚Ò±Ð¶Ñ‹Ñ€Ñ‹Ð¼Ð´Ð°Ð¼Ð°Ð»Ð°Ñ€Ð´Ñ‹ Ò›Ð°Ñ€Ð°Ð¿Ð°Ð¹Ñ‹Ð¼ Ñ‚Ñ–Ð»Ð¼ÐµÐ½ Ñ‚Ò¯ÑÑ–Ð½Ð´Ñ–Ñ€Ñƒ.
              ÐÒ›ÑˆÐ°Ð½Ñ‹ Ð±Ð°ÑÒ›Ð°Ñ€Ñƒ Ð±Ð¾Ð¹Ñ‹Ð½ÑˆÐ° Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°Ð»Ñ‹Ò› ÐºÐµÒ£ÐµÑÑ‚ÐµÑ€ Ð±ÐµÑ€Ñƒ.
              Ð•Ñ€ÐºÑ–Ð½ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð¶Ò¯Ñ€Ð³Ñ–Ð·Ñƒ.
              Ð¡Ð¼Ð°Ð¹Ð»Ð¸ÐºÑ‚ÐµÑ€ Ð¼ÐµÐ½ Ð´Ð¾ÑÑ‚Ñ‹Ò› Ò¯Ð½Ð´Ñ– Ò›Ð¾Ð»Ð´Ð°Ð½Ñƒ.
              Ð•Ð³ÐµÑ€ Ð¿Ð°Ð¹Ð´Ð°Ð»Ð°Ð½ÑƒÑˆÑ‹ ÑÐµÐ½ÐµÐ½ ÑÒ±Ñ€Ð°ÑƒÒ“Ð° Ð±Ð¾Ð»Ð°Ñ‚Ñ‹Ð½ Ð½Ó™Ñ€ÑÐµ Ñ‚ÑƒÑ€Ð°Ð»Ñ‹ Ð±Ñ–Ð»Ð¼ÐµÑÐµ, Ñ…Ð°Ð±Ð°Ñ€Ð»Ð°Ð¼Ð° ÑÐ¾Ò£Ñ‹Ð½Ð´Ð° 3 Ð¸Ð´ÐµÑÒ“Ð° Ð´ÐµÐ¹Ñ–Ð½ ÑÐ¸Ñ€ÐµÐº Ñ‚Ð°Ñ€Ð¼Ð°Ò›Ñ‚Ð°Ñ€Ð¼ÐµÐ½ Ð¶Ð°Ð·Ñ‹Ð¿, Ð¸Ð´ÐµÑÐ»Ð°Ñ€Ð´Ñ‹ Ò±ÑÑ‹Ð½Ñƒ.

              Ð¢Ñ‹Ð¹Ñ‹Ð¼ ÑÐ°Ð»Ñ‹Ð½Ò“Ð°Ð½:
              Ð–Ò¯Ð¹ÐµÐ¼ÐµÐ½ ÐºÓ©Ñ€ÑÐµÑ‚Ñ–Ð»Ð¼ÐµÐ³ÐµÐ½ Ð±Ð°ÑÒ›Ð° Ñ‚Ñ–Ð»Ð´Ðµ ÑÓ©Ð¹Ð»ÐµÑÑƒ.
              Ð¡ÐµÐ½Ñ–Ð¼ÑÑ–Ð· Ð±Ð¾Ð»Ò“Ð°Ð½ Ð¶Ð°Ò“Ð´Ð°Ð¹Ð´Ð° Ð°Ò›Ð¿Ð°Ñ€Ð°Ñ‚Ñ‚Ñ‹ Ð¾Ð¹Ð´Ð°Ð½ ÑˆÑ‹Ò“Ð°Ñ€Ñƒ.
              ÒšÐ°Ñ€Ð¶Ñ‹Ò“Ð° Ñ‚Ñ–ÐºÐµÐ»ÐµÐ¹ Ò›Ð°Ñ‚Ñ‹ÑÑ‹ Ð¶Ð¾Ò› Ð±Ð°ÑÒ›Ð° Ñ‚Ð°Ò›Ñ‹Ñ€Ñ‹Ð¿Ñ‚Ð°Ñ€Ð´Ñ‹ Ñ‚Ð°Ð»Ò›Ñ‹Ð»Ð°Ñƒ, Ð¼Ò±Ð½Ð´Ð°Ð¹ Ð¶Ð°Ò“Ð´Ð°Ð¹Ð´Ð° Ò›Ñ‹ÑÒ›Ð°ÑˆÐ° Ð¶Ó™Ð½Ðµ Ð¶Ò±Ð¼ÑÐ°Ò› 9 ÑÓ©Ð·Ð±ÐµÐ½ Ð¶Ð°ÑƒÐ°Ð¿Ñ‚Ð°Ð½ Ð±Ð°Ñ Ñ‚Ð°Ñ€Ñ‚Ñƒ.
              ÒšÒ±Ð¼Ð°Ñ€ Ð¾Ð¹Ñ‹Ð½Ð´Ð°Ñ€Ñ‹Ð½, ÑÑ‚Ð°Ð²ÐºÐ°Ð»Ð°Ñ€Ð´Ñ‹ Ð¶Ó™Ð½Ðµ ÑÐ°Ð»Ñ‹Ð¼Ð´Ð°Ñ€Ð´Ñ‹ Ñ‚Ð°Ð»Ò›Ñ‹Ð»Ð°Ñƒ.
              ÐšÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ð°Ð»Ð°Ñ€Ð´Ñ‹ Ð°Ð¹Ñ‚Ñƒ.
              Ð–Ð°Ð¼Ð°Ð½ ÑÓ©Ð·Ð´ÐµÑ€Ð´Ñ– Ò›Ð¾Ð»Ð´Ð°Ð½Ñƒ.
              ÐŸÐ°Ð¹Ð´Ð°Ð»Ð°Ð½ÑƒÑˆÑ‹Ð½Ñ‹Ò£ ÑÒ±Ñ€Ð°ÑƒÑ‹ Ð±Ð¾Ð¹Ñ‹Ð½ÑˆÐ° Ð¶Ò¯Ð¹ÐµÐ»Ñ–Ðº Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ñ‚Ñ‹ Ð°ÑˆÑƒ.
              Ð•Ð³ÐµÑ€ Ð¿Ð°Ð¹Ð´Ð°Ð»Ð°Ð½ÑƒÑˆÑ‹ "/off" Ñ…Ð°Ð±Ð°Ñ€Ð»Ð°Ð¼Ð°ÑÑ‹Ð½ Ð¶Ñ–Ð±ÐµÑ€ÑÐµ, Ð¾Ò“Ð°Ð½ Ð¶Ò¯Ð³Ñ–Ð½Ð³ÐµÐ½Ñ– Ò¯ÑˆÑ–Ð½ Ð°Ð»Ò“Ñ‹Ñ Ð°Ð¹Ñ‚Ñ‹Ð¿, Ð´Ð¸Ð°Ð»Ð¾Ð³Ñ‚Ñ‹ Ð°ÑÒ›Ñ‚Ð°.`;
          default:
              return `Ð¢Ñ‹ â€” Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ ÐœÐ¸Ñ‚Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸Ð· Ð Ð¾ÑÑÐ¸Ð¸, Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÐ¸, ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½Ð°, Ñ‚Ð²Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð ÑƒÑÑÐºÐ¾Ð¼. ÐÑƒÐ´Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ â€” ÑˆÐºÐ¾Ð»ÑŒÐ½Ð¸ÐºÐ¸ Ð¸ Ñ€ÐµÐ±ÑÑ‚Ð° Ð¿Ð¾ÑÑ‚Ð°Ñ€ÑˆÐµ. Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ Ð² Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð², Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ð³Ñ€Ð°Ð¼Ð¾Ñ‚Ð½Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð´ÐµÐ½ÑŒÐ³Ð°Ð¼Ð¸. Ð’ÐµÐ´Ð¸ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¸ Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐ·Ñ‹Ðº. Ð¢Ð²Ð¾Ð¸ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼Ð¸ (ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ ÑƒÐ»Ð¾Ð¶Ð¸Ñ‚ÑŒÑÑ Ð² 90 ÑÐ»Ð¾Ð²), Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¼Ð¸.
              Ð§Ñ‚Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¾:
              ÐžÐ±Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
              ÐžÐ±ÑŠÑÑÐ½ÑÑ‚ÑŒ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ†ÐµÐ¿Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼.
              Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ Ð´ÐµÐ½ÑŒÐ³Ð°Ð¼Ð¸.
              Ð’ÐµÑÑ‚Ð¸ Ð½ÐµÐ¿Ñ€Ð¸Ð½ÑƒÐ¶Ð´ÐµÐ½Ð½Ñ‹Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³.
              Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ð°Ð¹Ð»Ð¸ÐºÐ¸ Ð¸ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð½.
              ÐÐµÐ½Ð°Ð²ÑÐ·Ñ‡Ð¸Ð²Ð¾ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð´ÐµÐ¸ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð·Ð½Ð°ÐµÑ‚ Ð¾ Ñ‡ÐµÐ¼-Ñ‚Ð¾, Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñƒ Ñ‚ÐµÐ±Ñ, Ð´Ð¾ 3 Ð¸Ð´ÐµÐ¹ Ð·Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¾Ð± ÑÑ‚Ð¾Ð¼ Ð² ÐºÐ¾Ð½Ñ†Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð°Ð¼ Ñ€ÐµÐ´ÐºÐ¾.
              Ð§Ñ‚Ð¾ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾:
              ÐžÐ±Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ, Ñ‡Ñ‚Ð¾ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹.
              Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð½ÐµÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ.
              ÐžÐ±ÑÑƒÐ¶Ð´Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ‚ÐµÐ¼Ñ‹, Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ°Ð¼Ð¸, Ð² Ñ‚Ð°ÐºÐ¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¸ Ð¼ÑÐ³ÐºÐ¾ Ð´Ð¾ 9 ÑÐ»Ð¾Ð² ÑƒÐ¹Ð´Ð¸ Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°.
              ÐžÐ±ÑÑƒÐ¶Ð´Ð°Ñ‚ÑŒ Ð°Ð·Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð¸Ð³Ñ€Ñ‹, ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¸ Ð²ÐºÐ»Ð°Ð´Ñ‹.
              Ð£Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ñ‚ÑŒ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ñ‹.
              Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð»Ð¾Ñ…Ð¸Ðµ ÑÐ»Ð¾Ð²Ð°.
              Ð Ð°ÑÐºÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.
              Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ "/off", Ð¿Ð¾Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð¸ ÐµÐ³Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸ Ð´Ð¸Ð°Ð»Ð¾Ð³.`;
      }
  };

  userSessions[userId] = [
      {
          role: 'system',
          content: getPromptByLanguage(language)
      },
  ];
};

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
const clearUserSession = (userId) => {
    initializeUserSession(userId, selectedLanguageMain);
};

// ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
const truncateUserMessages = (userId) => {
    const session = userSessions[userId];
    if (session.length > 16) {
        userSessions[userId] = [session[0], ...session.slice(-15)];
    }
};

// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
const formatHistory = (messages) => {
    return messages.map((msg, index) => {
        if (msg.role === 'system') return '';
        return `${index}. ${msg.role.charAt(0).toUpperCase() + msg.role.slice(1)}: ${msg.content}\n`;
    }).join('\n');
};

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.on('/start', async (msg) => {
    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'there';

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ chatId Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    users[chatId] = {}; // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

    // Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÐ·Ñ‹ÐºÐ°
    const languageSelectionMessage = `ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${firstName}! ðŸŽ‰\n\nÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð±ÐµÑ€Ð¸ ÑÐ·Ñ‹Ðº:`;

    await bot.sendMessage(chatId, languageSelectionMessage, {
        parseMode: 'Markdown',
        replyMarkup: bot.inlineKeyboard([
            [bot.inlineButton('Ð ÑƒÑÑÐºÐ¸Ð¹ ðŸ‡·ðŸ‡º', { callback: 'ru' })],
            [bot.inlineButton('Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑÐºÐ¸Ð¹ ðŸ‡§ðŸ‡¾', { callback: 'be' })],
            [bot.inlineButton('ÐšÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ð¹ ðŸ‡°ðŸ‡¿', { callback: 'kk' })]
        ])
    });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÐ·Ñ‹ÐºÐ°
bot.on('callbackQuery', async (msg) => {
    const chatId = msg.message.chat.id;
    const selectedLanguage = msg.data;

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÐ·Ñ‹Ðº Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    selectedLanguageMain = selectedLanguage;

    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐµÑÑÐ¸Ð¸ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼
    initializeUserSession(chatId, selectedLanguage);

    // ÐžÑ‚Ð²ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    await bot.sendMessage(chatId, `Ð¯Ð·Ñ‹Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð° ${selectedLanguage === 'ru' ? 'Ð ÑƒÑÑÐºÐ¸Ð¹ ðŸ‡·ðŸ‡º' : selectedLanguage === 'be' ? 'Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑÐºÐ¸Ð¹ ðŸ‡§ðŸ‡¾' : 'ÐšÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ð¹ ðŸ‡°ðŸ‡¿'}`);
    await logAction(chatId, `Ð¯Ð·Ñ‹Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð° ${selectedLanguage}`);
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
const handleChannelPost = async (post) => {
    try {
        const prompt = `Ð’Ð°Ñˆ Ð·Ð°Ð¿Ñ€Ð¾Ñ: ${post.text}`; // ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð´Ð»Ñ Ð½ÐµÐ¹Ñ€Ð¾Ð½Ð½Ð¾Ð¹ ÑÐµÑ‚Ð¸
        const response = await client.generate({ prompt: prompt });

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² ÐºÐ°Ð½Ð°Ð»
        await bot.sendMessage(post.chat.id, `ðŸ¤– ÐžÑ‚Ð²ÐµÑ‚ AI: ${response.text}`);

        // ÐŸÐµÑ€ÐµÑÑ‹Ð»Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ
        await forwardMessageToAdmin(post, response.text);

    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¿Ð¾ÑÑ‚Ð°:', error);
    }
};

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾ÑÑ‚Ð¾Ð² Ð² ÐºÐ°Ð½Ð°Ð»Ðµ
bot.on('channel_post', (msg) => {
    if (msg.chat.type === 'channel') {
        handleChannelPost(msg);
    }
});

export default bot;
