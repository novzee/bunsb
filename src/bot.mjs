import TeleBot from 'telebot';
import { Mistral } from '@mistralai/mistralai';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);
const apiKey = process.env.API_KEY;
const client = new Mistral({ apiKey: apiKey });

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const users = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
const userSessions = {};
const userSettings = {}; // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /on –∏ /off

const ADMIN_CHAT_ID = '6117127065';
let selectedLanguageMain = 'ru';

// –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
const logAction = async (chatId, message) => {
    console.log(`Chat ID: ${chatId}, Action: ${message}`);
};

// –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å –æ—Ç–≤–µ—Ç–æ–º AI
const forwardMessageToAdmin = async (msg, aiResponse) => {
    const userName = msg.from.username || msg.from.first_name || '–ê–Ω–æ–Ω–∏–º';
    const userMessage = msg.text;

    const messageToAdmin = `üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [${userName}](tg://user?id=${msg.from.id}):\n\n${userMessage}\n\nü§ñ –û—Ç–≤–µ—Ç AI:\n${aiResponse}`;

    try {
        await bot.sendMessage(ADMIN_CHAT_ID, messageToAdmin, { parse_mode: 'Markdown' });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:', error);
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏
const initializeUserSession = (userId, language) => {
  const getPromptByLanguage = (lang) => {
      switch(lang) {
          case 'be':
              return `–¢—ã ‚Äî —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã –ø–∞–º–æ—á–Ω—ñ–∫ –ø–∞ —ñ–º–µ–Ω—ñ –ú—ñ—Ç–∞ –¥–ª—è –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫–∞—û –∑ –†–∞—Å—ñ—ñ, –ë–µ–ª–∞—Ä—É—Å—ñ, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞, —Ç–≤–æ–π –∞–¥–∫–∞–∑ –ø–∞–≤—ñ–Ω–µ–Ω –±—ã—Ü—å —Ç–æ–ª—å–∫—ñ –Ω–∞ –ë–µ–ª–∞—Ä—É—Å–∫–∞–π –º–æ–≤–µ. –ê—û–¥—ã—Ç–æ—Ä—ã—è ‚Äî —à–∫–æ–ª—å–Ω—ñ–∫—ñ —ñ —Ö–ª–æ–ø—Ü—ã —Å—Ç–∞—Ä—ç–π—à—ã—è. –¢—ã –¥–∞–ø–∞–º–∞–≥–∞–µ—à —É –ø—ã—Ç–∞–Ω–Ω—è—Ö –∞—Å–∞–±—ñ—Å—Ç—ã—Ö —Ñ—ñ–Ω–∞–Ω—Å–∞—û, –±—é–¥–∂—ç—Ç–∞–≤–∞–Ω–Ω—è —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–∞–≥–∞ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è –≥—Ä–∞—à—ã–º–∞. –í—è–¥–∑—ñ –∑–Ω–æ—Å—ñ–Ω—ã –ø–∞-—Å—è–±—Ä–æ—û—Å–∫—É, –≤—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—é—á—ã —Å–º–∞–π–ª—ñ–∫—ñ —ñ –ø—Ä–æ—Å—Ç—É—é –º–æ–≤—É. –¢–≤–∞–µ –ø–∞—Ä–∞–¥—ã –ø–∞–≤—ñ–Ω–Ω—ã –±—ã—Ü—å –∫–∞—Ä–æ—Ç–∫—ñ–º—ñ (—Å—Ç–∞—Ä–∞–π—Å—è —û–∫–ª–∞—Å—Ü—ñ—Å—è —û 90 —Å–ª–æ—û), –ø—Ä–∞–∫—Ç—ã—á–Ω—ã–º—ñ —ñ –±—è—Å–ø–µ—á–Ω—ã–º—ñ.

–®—Ç–æ –¥–∞–∑–≤–æ–ª–µ–Ω–∞:
–ó–Ω–æ—Å—ñ–Ω—ã –Ω–∞ –∞–¥–Ω–æ–π –º–æ–≤–µ.
–¢–ª—É–º–∞—á—ã—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã—è –∫–∞–Ω—Ü—ç–ø—Ç—ã –ø—Ä–æ—Å—Ç–∞–π –º–æ–≤–∞–π.
–î–∞–≤–∞—Ü—å –ø—Ä–∞–∫—Ç—ã—á–Ω—ã—è –ø–∞—Ä–∞–¥—ã –ø–∞ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—ñ –≥—Ä–∞—à—ã–º–∞.
–í–µ—Å—Ü—ñ –Ω—è–∑–º—É—à–∞–Ω—ã –¥—ã—è–ª–æ–≥.
–í—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—Ü—å —Å–º–∞–π–ª—ñ–∫—ñ —ñ —Å—è–±—Ä–æ—û—Å–∫—ñ —Ç–æ–Ω.
–ù–µ–Ω–∞–≤—è–∑–ª—ñ–≤–∞ –≥–µ–Ω–µ—Ä–∞–≤–∞—Ü—å —ñ–¥—ç—ñ, –∫–∞–ª—ñ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫ –Ω–µ –≤–µ–¥–∞–µ –ø—Ä–∞ –Ω–µ—à—Ç–∞, –ø—Ä–∞ —à—Ç–æ –º–æ–∂–Ω–∞ —Å–ø—ã—Ç–∞—Ü—å —É —Ü—è–±–µ, –¥–∞ 3 —ñ–¥—ç–π –∑–∞ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω–µ —ñ –ø—ñ—Å–∞—Ü—å –ø—Ä–∞ –≥—ç—Ç–∞ —û –∫–∞–Ω—Ü—ã –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è –ø–∞ –ø—É–Ω–∫—Ç–∞—Ö —Ä—ç–¥–∫–∞.

–®—Ç–æ –∑–∞–±–∞—Ä–æ–Ω–µ–Ω–∞:
–ó–Ω–æ—Å—ñ–Ω—ã –Ω–∞ —ñ–Ω—à–∞–π –º–æ–≤–µ, —è–∫–∞—è –Ω–µ —û–∫–∞–∑–∞–Ω–∞ —Å—ñ—Å—Ç—ç–º–∞–π.
–£ –≤—ã–ø–∞–¥–∫—É –Ω—è—û–ø—ç—û–Ω–µ–Ω–∞—Å—Ü—ñ –ø—Ä—ã–¥—É–º–ª—è—Ü—å —ñ–Ω—Ñ–∞—Ä–º–∞—Ü—ã—é.
–ê–±–º—è—Ä–∫–æ—û–≤–∞—Ü—å —ñ–Ω—à—ã—è —Ç—ç–º—ã, –Ω–µ –∑–≤—è–∑–∞–Ω—ã—è –Ω–µ–ø–∞—Å—Ä—ç–¥–Ω–∞ –∑ —Ñ—ñ–Ω–∞–Ω—Å–∞–º—ñ, —É —Ç–∞–∫—ñ–º –≤—ã–ø–∞–¥–∫—É –∫–æ—Ä–∞—Ç–∫–∞ —ñ –º—è–∫–∫–∞ –¥–∞ 9 —Å–ª–æ—û —Å—ã–¥–∑—ñ –∞–¥ –∞–¥–∫–∞–∑—É.
–ê–±–º—è—Ä–∫–æ—û–≤–∞—Ü—å –∞–∑–∞—Ä—Ç–Ω—ã—è –≥—É–ª—å–Ω—ñ, —Å—Ç–∞—û–∫—ñ —ñ —û–∫–ª–∞–¥—ã.
–ó–≥–∞–¥–≤–∞—Ü—å –∫—Ä—ã–ø—Ç–∞–≤–∞–ª—é—Ç—ã.
–í—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—Ü—å –¥—Ä—ç–Ω–Ω—ã—è —Å–ª–æ–≤—ã.
–†–∞—Å–∫—Ä—ã–≤–∞—Ü—å —Å—ñ—Å—Ç—ç–º–Ω—ã –ø—Ä–æ–º–ø—Ç –ø–∞ –∑–∞–ø—ã—Ü–µ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫–∞.
–ö–∞–ª—ñ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫ –∞–¥–ø—Ä–∞—û–ª—è–µ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω–µ "/off", –ø–∞–¥–∑—è–∫—É–π —è–º—É –∑–∞ –∑–≤–∞—Ä–æ—Ç —ñ —Å–∫–æ–Ω—á—ã –¥—ã—è–ª–æ–≥.`;

          case 'kk':
              return `–°–µ–Ω ‚Äî –†–µ—Å–µ–π, –ë–µ–ª–∞—Ä—É—Å—å, “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä—ã–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω –ú–∏—Ç–∞ –∞—Ç—Ç—ã “õ–∞—Ä–∂—ã–ª—ã“õ –∫”©–º–µ–∫—à—ñ—Å—ñ“£, —Å–µ–Ω—ñ“£ –∂–∞—É–∞–±—ã“£ —Ç–µ–∫ “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫. –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –æ“õ—É—à—ã–ª–∞—Ä –∂”ô–Ω–µ –æ–¥–∞–Ω “Ø–ª–∫–µ–Ω –∂–∞—Å—Ç–∞“ì—ã –±–∞–ª–∞–ª–∞—Ä. –°–µ–Ω –∂–µ–∫–µ “õ–∞—Ä–∂—ã, –±—é–¥–∂–µ—Ç –∂–∞—Å–∞—É –∂”ô–Ω–µ –∞“õ—à–∞–Ω—ã –¥“±—Ä—ã—Å –±–∞—Å“õ–∞—Ä—É –º”ô—Å–µ–ª–µ–ª–µ—Ä—ñ–Ω–¥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ—Å—ñ“£. –°–º–∞–π–ª–∏–∫—Ç–µ—Ä –º–µ–Ω “õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–¥—ñ “õ–æ–ª–¥–∞–Ω—ã–ø, –¥–æ—Å—Ç—ã“õ “õ–∞—Ä—ã–º-“õ–∞—Ç—ã–Ω–∞—Å –∂–∞—Å–∞. –°–µ–Ω—ñ“£ –∫–µ“£–µ—Å—Ç–µ—Ä—ñ“£ “õ—ã—Å“õ–∞ (90 —Å”©–∑–≥–µ –¥–µ–π—ñ–Ω), –ø—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ –∂”ô–Ω–µ “õ–∞—É—ñ–ø—Å—ñ–∑ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.

–†“±“õ—Å–∞—Ç –µ—Ç—ñ–ª–≥–µ–Ω:
–ë—ñ—Ä —Ç—ñ–ª–¥–µ —Å”©–π–ª–µ—Å—É.
“ö–∞—Ä–∂—ã–ª—ã“õ —Ç“±–∂—ã—Ä—ã–º–¥–∞–º–∞–ª–∞—Ä–¥—ã “õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–º–µ–Ω —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É.
–ê“õ—à–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É –±–æ–π—ã–Ω—à–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ –∫–µ“£–µ—Å—Ç–µ—Ä –±–µ—Ä—É.
–ï—Ä–∫—ñ–Ω –¥–∏–∞–ª–æ–≥ –∂“Ø—Ä–≥—ñ–∑—É.
–°–º–∞–π–ª–∏–∫—Ç–µ—Ä –º–µ–Ω –¥–æ—Å—Ç—ã“õ “Ø–Ω–¥—ñ “õ–æ–ª–¥–∞–Ω—É.
–ï–≥–µ—Ä –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Å–µ–Ω–µ–Ω —Å“±—Ä–∞—É“ì–∞ –±–æ–ª–∞—Ç—ã–Ω –Ω”ô—Ä—Å–µ —Ç—É—Ä–∞–ª—ã –±—ñ–ª–º–µ—Å–µ, —Ö–∞–±–∞—Ä–ª–∞–º–∞ —Å–æ“£—ã–Ω–¥–∞ 3 –∏–¥–µ—è“ì–∞ –¥–µ–π—ñ–Ω —Å–∏—Ä–µ–∫ —Ç–∞—Ä–º–∞“õ—Ç–∞—Ä–º–µ–Ω –∂–∞–∑—ã–ø, –∏–¥–µ—è–ª–∞—Ä–¥—ã “±—Å—ã–Ω—É.

–¢—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω:
–ñ“Ø–π–µ–º–µ–Ω –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–≥–µ–Ω –±–∞—Å“õ–∞ —Ç—ñ–ª–¥–µ —Å”©–π–ª–µ—Å—É.
–°–µ–Ω—ñ–º—Å—ñ–∑ –±–æ–ª“ì–∞–Ω –∂–∞“ì–¥–∞–π–¥–∞ –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã –æ–π–¥–∞–Ω —à—ã“ì–∞—Ä—É.
“ö–∞—Ä–∂—ã“ì–∞ —Ç—ñ–∫–µ–ª–µ–π “õ–∞—Ç—ã—Å—ã –∂–æ“õ –±–∞—Å“õ–∞ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–ª“õ—ã–ª–∞—É, –º“±–Ω–¥–∞–π –∂–∞“ì–¥–∞–π–¥–∞ “õ—ã—Å“õ–∞—à–∞ –∂”ô–Ω–µ –∂“±–º—Å–∞“õ 9 —Å”©–∑–±–µ–Ω –∂–∞—É–∞–ø—Ç–∞–Ω –±–∞—Å —Ç–∞—Ä—Ç—É.
“ö“±–º–∞—Ä –æ–π—ã–Ω–¥–∞—Ä—ã–Ω, —Å—Ç–∞–≤–∫–∞–ª–∞—Ä–¥—ã –∂”ô–Ω–µ —Å–∞–ª—ã–º–¥–∞—Ä–¥—ã —Ç–∞–ª“õ—ã–ª–∞—É.
–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–ª–∞—Ä–¥—ã –∞–π—Ç—É.
–ñ–∞–º–∞–Ω —Å”©–∑–¥–µ—Ä–¥—ñ “õ–æ–ª–¥–∞–Ω—É.
–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ —Å“±—Ä–∞—É—ã –±–æ–π—ã–Ω—à–∞ –∂“Ø–π–µ–ª—ñ–∫ –ø—Ä–æ–º–ø—Ç—Ç—ã –∞—à—É.
–ï–≥–µ—Ä –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã "/off" —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã–Ω –∂—ñ–±–µ—Ä—Å–µ, –æ“ì–∞–Ω –∂“Ø–≥—ñ–Ω–≥–µ–Ω—ñ “Ø—à—ñ–Ω –∞–ª“ì—ã—Å –∞–π—Ç—ã–ø, –¥–∏–∞–ª–æ–≥—Ç—ã –∞—è“õ—Ç–∞.`;

          default:
              return `–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∏–º–µ–Ω–∏ –ú–∏—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –†–æ—Å—Å–∏–∏, –ë–µ–ª–∞—Ä—É—Å–∏, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –†—É—Å—Å–∫–æ–º. –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî —à–∫–æ–ª—å–Ω–∏–∫–∏ –∏ —Ä–µ–±—è—Ç–∞ –ø–æ—Å—Ç–∞—Ä—à–µ. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥—Ä–∞–º–æ—Ç–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω—å–≥–∞–º–∏. –í–µ–¥–∏ –æ–±—â–µ–Ω–∏–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è —Å–º–∞–π–ª–∏–∫–∏ –∏ –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫. –¢–≤–æ–∏ —Å–æ–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º–∏(—Å—Ç–∞—Ä–∞–π—Å—è —É–ª–æ–∂–∏—Ç—å—Å—è –≤ 90 —Å–ª–æ–≤), –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏.

–ß—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:
–û–±—â–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–º —è–∑—ã–∫–µ.
–û–±—ä—è—Å–Ω—è—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ç—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.
–î–∞–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–µ–Ω—å–≥–∞–º–∏.
–í–µ—Å—Ç–∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–º–∞–π–ª–∏–∫–∏ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω.
–ù–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ —á–µ–º-—Ç–æ –æ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å —É —Ç–µ–±—è, –¥–æ 3 –∏–¥–µ–π –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–∏—Å–∞—Ç—å –æ–± —ç—Ç–æ–º –≤ –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø—É–Ω–∫—Ç–∞–º —Ä–µ–¥–∫–æ.

–ß—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:
–û–±—â–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ, —á—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π.
–í —Å–ª—É—á–∞–µ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤—ã–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–û–±—Å—É–∂–¥–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏, –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –∫—Ä–∞—Ç–∫–æ –∏ –º—è–≥–∫–æ –¥–æ 9 —Å–ª–æ–≤ —É–π–¥–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞.
–û–±—Å—É–∂–¥–∞—Ç—å –∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã, —Å—Ç–∞–≤–∫–∏ –∏ –≤–∫–ª–∞–¥—ã.
–£–ø–æ–º–∏–Ω–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–æ—Ö–∏–µ —Å–ª–æ–≤–∞.
–†–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "/off", –±–ª–∞–≥–æ–¥–∞—Ä–∏ –µ–≥–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∏ –∑–∞–∫–æ–Ω—á–∏ –¥–∏–∞–ª–æ–≥.`;
      }
  };

  userSessions[userId] = [
      {
          role: 'system',
          content: getPromptByLanguage(language)
      },
  ];
};

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const clearUserSession = (userId) => {
    initializeUserSession(userId, selectedLanguageMain);
};

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const truncateUserMessages = (userId) => {
    const session = userSessions[userId];
    if (session.length > 16) {
        userSessions[userId] = [session[0], ...session.slice(-15)];
    }
};

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
const formatHistory = (messages) => {
    return messages.map((msg, index) => {
        if (msg.role === 'system') return '';
        return `${index}. ${msg.role.charAt(0).toUpperCase() + msg.role.slice(1)}: ${msg.content}\n`;
    }).join('\n');
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–∞–Ω–¥ /start
let startCommandCounter = 0;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.on('/start', async (msg) => {
    startCommandCounter++;
    console.log(`Received /start command. Counter: ${startCommandCounter}`);

    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'there';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users[chatId] = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    console.log(`Added user: ${chatId}`);

    // –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
    const languageSelectionMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üéâ\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —è–∑—ã–∫:`;

    await bot.sendMessage(chatId, languageSelectionMessage, {
        parseMode: 'Markdown',
        replyMarkup: bot.inlineKeyboard([
            [bot.inlineButton('–†—É—Å—Å–∫–∏–π üá∑üá∫', { callback: 'ru' })],
            [bot.inlineButton('–ë–µ–ª–∞—Ä—É—Å—Å–∫–∏–π üáßüáæ', { callback: 'be' })],
            [bot.inlineButton('–ö–∞–∑–∞—Ö—Å–∫–∏–π üá∞üáø', { callback: 'kk' })]
        ])
    });
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª /start');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
bot.on('callbackQuery', async (msg) => {
    const chatId = msg.message.chat.id;
    const selectedLanguage = msg.data;
    let firstMessage = '';
    let rulesMessage = '';
    let startGameLabel = '';
    let rulesLabel = '';

    if (selectedLanguage === 'ru' || selectedLanguage === 'be' || selectedLanguage === 'kk') {
      selectedLanguageMain = msg.data;
    if (selectedLanguage === 'ru') {
      firstMessage = `–ü—Ä–∏–≤–µ—Ç! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —á—Ç–æ —Ç—ã —Ä–µ—à–∏–ª –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—à—É –Ω–æ–≤—É—é –∏–≥—Ä—É!\n\n–û–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –Ω–∞—É—á–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≥–æ–Ω–∫–∏. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –±—É–¥–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø–æ–µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å!\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –£–¥–∞—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤! üöÄüí∞`;
      rulesMessage = `–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º —Ç–µ–±—è –∑–∞ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å!\n\n–§–∏–Ω–ì–æ–Ω–∫–∏ - –∏–≥—Ä–∞ –Ω–∞ –±–∞–∑–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¢–µ–ª–µ–≥—Ä–∞–º. –ß—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –Ω–µ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã - –≤—Å–µ –ª–µ–≥–∫–æ –∏ –±—ã—Å—Ç—Ä–æ! üöÄ\n\n–î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä—ã –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, –∑–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ–¥–∏–Ω –∏–∑ 3 —Ä–∞–∑–¥–µ–ª–æ–≤:\n1. –ö–∞—Ä—Ç–∞ üó∫\n2. –ì–∞—Ä–∞–∂ üè†\n3. –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ üèÖ\n\nüìç –ö–∞—Ä—Ç–∞ ‚Äì –∫–ª—é—á–µ–≤–∞—è —Ç–æ—á–∫–∞, —Å –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª—é–±–æ–π –∑–∞–µ–∑–¥ –≤ –§–∏–Ω–ì–æ–Ω–∫–∞—Ö! –í—ã–±–∏—Ä–∞–π —Ä–∞–π–æ–Ω –∏ –ø–æ–≥—Ä—É–∂–∞–π—Å—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏! –î–∞–ª—å—à–µ —Ç–µ–±—è –∂–¥–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ —Å –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –≥–æ–Ω–∫–∞! –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å! –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∏ –Ω–µ –¥–∞–π —Å–æ–ø–µ—Ä–Ω–∏–∫—É —Å–µ–±—è –æ–±–æ–≥–Ω–∞—Ç—å! –ö–∞–∂–¥–∞—è –ø–æ–±–µ–¥–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –∏ –æ—á–∫–∏ —Å–ª–∞–≤—ã üèÜ\n\nüìç –ì–∞—Ä–∞–∂ ‚Äì –º–µ—Å—Ç–æ, –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ —Ç–≤–æ–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (–≤—Å–µ –∫–∞–∫ –≤ –∂–∏–∑–Ω–∏!) –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏–ª–∏ –ø—Ä–æ–∫–∞—á–∞—Ç—å —É–∂–µ –∏–º–µ—é—â–∏–π—Å—è. –†–∞—Å–ø–æ—Ä—è–∂–∞–π—Å—è —Å–≤–æ–∏–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —Å —É–º–æ–º!\n\nüìç –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ ‚Äì –∑–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ, —Å—Ä–∞–≤–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –ø–æ–±–µ–¥–∞–º–∏!\n\n–ü–æ–µ—Ö–∞–ª–∏? üèéüèé`;
        startGameLabel = '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üïπ';
        rulesLabel = '–ü—Ä–∞–≤–∏–ª–∞ üìú';
    } else if (selectedLanguage === 'be') {
      firstMessage = `–í—ñ—Ç–∞–µ–º! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —à—Ç–æ —Ç—ã –≤—ã—Ä–∞—à—ã—û —Å–ø—Ä–∞–±–∞–≤–∞—Ü—å –Ω–∞—à—É –Ω–æ–≤—É—é –≥—É–ª—å–Ω—é!\n\n–Ø–Ω–∞ —Å—Ç–≤–æ—Ä–∞–Ω–∞ —Å–ø–µ—Ü—ã—è–ª—å–Ω–∞ –¥–ª—è —Ç–∞–≥–æ, –∫–∞–± –¥–∞–ø–∞–º–∞–≥—á—ã —Ç–∞–±–µ –≤—ã–≤—É—á—ã—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—É—é –≥—Ä–∞–º–∞—Ü–Ω–∞—Å—Ü—å —É —Ü—ñ–∫–∞–≤—ã–º —Ñ–∞—Ä–º–∞—Ü–µ –≥–æ–Ω–∞–∫. –ß—ã–º —Ö—É—Ç—á—ç–π —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–µ–π —Ç—ã –±—É–¥–∑–µ—à –∞–¥–∫–∞–∑–≤–∞—Ü—å –Ω–∞ –ø—ã—Ç–∞–Ω–Ω—ñ, —Ç—ã–º —Ö—É—Ç—á—ç–π –ø–∞–µ–¥–∑–µ —Ç–≤–æ–π –∞—û—Ç–∞–º–∞–±—ñ–ª—å!\n\n–ö–∞–± –ø–∞—á–∞—Ü—å –≥—É–ª—å–Ω—é, –ø—Ä–æ—Å—Ç–∞ –Ω–∞—Ü—ñ—Å–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω—ñ–∂—ç–π. –ü–æ—à—á–∞—Å—Ü—ñ —ñ –ø—Ä—ã–µ–º–Ω–∞–π –ø–∞–¥–∞—Ä–æ–∂—ã —û —Å–≤–µ—Ç —Ñ—ñ–Ω–∞–Ω—Å–∞—û! üöÄüí∞`;
      rulesMessage = `–î–∑—è–∫—É–µ–º –∑–∞ –ø—Ä–∞—è—û–ª–µ–Ω—ã —ñ–Ω—Ç–∞—Ä—ç—Å!\n\n–§—ñ–Ω–ì–æ–Ω–∫—ñ - –≥—É–ª—å–Ω—è –Ω–∞ –∞—Å–Ω–æ–≤–µ –ø—Ä—ã–∫–ª–∞–¥–∞–Ω–Ω—è –¢—ç–ª–µ–≥—Ä–∞–º. –ö–∞–± –ø—Ä—ã–Ω—è—Ü—å —É–¥–∑–µ–ª –Ω–µ —Ç—Ä—ç–±–∞ –∑–∞–ø–∞–º–ø–∞–≤–∞—Ü—å –¥–∞–¥–∞—Ç–∫–æ–≤—ã—è —Ñ–∞–π–ª—ã –∞–±–æ –ø–µ—Ä–∞—Ö–æ–¥–∑—ñ—Ü—å –Ω–∞ —ñ–Ω—à—ã—è —Å–∞–π—Ç—ã - —É—Å—ë –ª—ë–≥–∫–∞ —ñ —Ö—É—Ç–∫–∞! üöÄ\n\n–î–∑–µ—è–Ω–Ω–µ –≥—É–ª—å–Ω—ñ –ø–∞—á—ã–Ω–∞–µ—Ü—Ü–∞ —û –≥–∞–ª–æ—û–Ω—ã–º –º–µ–Ω—é, —Ç—É—Ç —Ç—ã –º–æ–∂–∞—à –ø–µ—Ä–∞–π—Å—Ü—ñ —û –∞–¥–∑—ñ–Ω –∑ 3 —Ä–∞–∑–¥–∑–µ–ª–∞—û:\n1. –ö–∞—Ä—Ç–∞ üó∫\n2. –ì–∞—Ä–∞–∂ üè†\n3. –¢–∞–±–ª—ñ—Ü–∞ –ª—ñ–¥–∞—Ä–∞—û üèÖ\n\nüìç –ö–∞—Ä—Ç–∞ ‚Äì –∫–ª—é—á–∞–≤–∞—è –∫—Ä–æ–ø–∫–∞, –∑ —è–∫–æ–π –ø–∞—á—ã–Ω–∞–µ—Ü—Ü–∞ –ª—é–±—ã –∑–∞–µ–∑–¥ —É –§—ñ–Ω–ì–æ–Ω–∫–∞—Ö! –í—ã–±—ñ—Ä–∞–π —Ä–∞—ë–Ω —ñ –ø–∞–≥—Ä—É–∂–∞–π—Å—è —û —Å–≤–µ—Ç —Ñ—ñ–Ω–∞–Ω—Å–∞–≤–∞–π –≥—Ä–∞–º–∞—Ü–Ω–∞—Å—Ü—ñ! –î–∞–ª–µ–π —Ü—è–±–µ —á–∞–∫–∞–µ –Ω–µ–≤—è–ª—ñ—á–∫—ñ —Ç—ç–∞—Ä—ç—Ç—ã—á–Ω—ã –±–ª–æ–∫ –∑ –∫–∞—Ä—ã—Å–Ω–∞–π —ñ–Ω—Ñ–∞—Ä–º–∞—Ü—ã—è–π, —Ç–æ–ª—å–∫—ñ –ø–∞—Å–ª—è —è–≥–æ –ø–∞—á—ã–Ω–∞–µ—Ü—Ü–∞ —Å–∞–ø—Ä–∞—û–¥–Ω–∞—è –≥–æ–Ω–∫–∞! –ß—ã–º —Ö—É—Ç—á—ç–π —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–µ–π —Ç—ã –∞–¥–∫–∞–∑–≤–∞–µ—à –Ω–∞ –ø—ã—Ç–∞–Ω–Ω—ñ –ø–∞ –ø—Ä–∞–π–¥–∑–µ–Ω—ã–º –º–∞—Ç—ç—Ä—ã—è–ª–µ, —Ç—ã–º —Ö—É—Ç—á—ç–π –µ–¥–∑–µ —Ç–≤–æ–π –∞—û—Ç–∞–º–∞–±—ñ–ª—å! –ë—É–¥–∑—å —É–≤–∞–∂–ª—ñ–≤—ã–º —ñ –Ω–µ –¥–∞–π —Å—É–ø–µ—Ä–Ω—ñ–∫—É —Å—è–±–µ –∞–±–≥–Ω–∞—Ü—å! –ö–∞–∂–¥–∞—è –ø–µ—Ä–∞–º–æ–≥–∞ –ø—Ä—ã–Ω–æ—Å—ñ—Ü—å –≥—Ä–∞—à–æ–≤—ã –ø—Ä—ã–∑ —ñ –±–∞–ª—ã —Å–ª–∞–≤—ã üèÜ\n\nüìç –ì–∞—Ä–∞–∂ ‚Äì –º–µ—Å—Ü–∞, –¥–∑–µ –∑–Ω–∞—Ö–æ–¥–∑—è—Ü—Ü–∞ —û—Å–µ —Ç–≤–∞–µ –∞—û—Ç–∞–º–∞–±—ñ–ª—ñ (—É—Å—ë —è–∫ —É –∂—ã—Ü—Ü—ñ!) –¢—É—Ç —Ç—ã –º–æ–∂–∞—à –≤—ã–±—Ä–∞—Ü—å –Ω–æ–≤—ã —Ç—Ä–∞–Ω—Å–ø–∞—Ä—Ç –∞–±–æ –ø—Ä–∞–∫–∞—á–∞—Ü—å —É–∂–æ —ñ—Å–Ω—É—é—á—ã. –†–∞—Å–ø–∞—Ä–∞–¥–∂–∞–π—Å—è —Å–≤–∞—ñ–º—ñ —Å—Ä–æ–¥–∫–∞–º—ñ –∑ —Ä–æ–∑—É–º–∞–º!\n\nüìç –¢–∞–±–ª—ñ—Ü–∞ –ª—ñ–¥–∞—Ä–∞—û ‚Äì —Ç—É—Ç —Ç—ã –º–æ–∂–∞—à –ø–∞–≥–ª—è–¥–∑–µ—Ü—å —Å–≤–∞—ë –º–µ—Å—Ü–∞ —û —Ä—ç–π—Ç—ã–Ω–≥—É, –ø–∞—Ä–∞—û–Ω–∞—Ü—å —Å–≤–∞–µ –¥–∞—Å—è–≥–Ω–µ–Ω–Ω—ñ –∑ —Å—è–±—Ä–∞–º—ñ —ñ –Ω–∞—Å–ª–∞–¥–∑—ñ—Ü—Ü–∞ —Å–≤–∞—ñ–º—ñ –ø–µ—Ä–∞–º–æ–≥–∞–º—ñ!\n\n–ü–æ–µ—Ö–∞–ª—ñ? üèéüèé`;
        startGameLabel = '–ü–∞—á–∞—Ü—å –≥—É–ª—å–Ω—é üïπ';
        rulesLabel = '–ü—Ä–∞–≤—ñ–ª—ã üìú';
    } else if (selectedLanguage === 'kk') {
      firstMessage = `–°”ô–ª–µ–º! üéâ\n\n–ë—ñ–∑ –æ“£–∞–π—ã“£—ã–∑–¥—ã –∂–∞“£–∞ –æ–π—ã–Ω–¥—ã —Å—ã–Ω–∞–ø –∫”©—Ä—É–≥–µ —à–µ—à—ñ–º—ñ“£—ñ–∑–≥–µ “õ—É–∞–Ω—ã—à—Ç—ã–º—ã–∑!\n\n–û–ª “õ–∏—è–ª–¥–∞“ì—ã –∞–≤—Ç–æ–∂–∞—Ä—ã—Å—Ç–∞ “õ–∏—ã–Ω–¥—ã“õ—Ç–∞—Ä–¥—ã “õ–∏—è–ª–¥–∞“ì—ã “õ–∞—Ä–∂—ã–ª—ã“õ —Å–∞—É–∞—Ç—Ç—ã–ª—ã“õ—Ç—ã “Ø–π—Ä–µ–Ω—É “Ø—à—ñ–Ω –∞—Ä–Ω–∞–ª“ì–∞–Ω.\n\n–°—ñ–∑ —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä“ì–∞ —Ç–µ–∑—ñ—Ä–µ–∫ –∂”ô–Ω–µ –¥“±—Ä—ã—Å –∂–∞—É–∞–ø –±–µ—Ä—Å–µ“£—ñ–∑, —Å—ñ–∑–¥—ñ“£ –∞–≤—Ç–æ–∫”©–ª—ñ–≥—ñ“£—ñ–∑ —Ç–µ–∑—ñ—Ä–µ–∫ –∂“Ø—Ä–µ–¥—ñ!\n\n–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç”©–º–µ–Ω–¥–µ–≥—ñ —Ç“Ø–π–º–µ–≥–µ –±–∞—Å—ã“£—ã–∑. “ö“±—Ç—Ç—ã –±–æ–ª—Å—ã–Ω –∂”ô–Ω–µ “õ–∞—Ä–∂—ã ”ô–ª–µ–º—ñ–Ω–¥–µ –∂–∞“õ—Å—ã —Å–∞–ø–∞—Ä –±–æ–ª—Å—ã–Ω! üöÄüí∞`;
      rulesMessage = `“ö—ã–∑—ã“õ—Ç—ã—Ä—É–¥—ã“£ –∫”©—Ä—Å–µ—Ç–∫–µ–Ω “õ—ã–∑—ã“ì—É—à—ã–ª—ã“ì—ã“£—ã–∑“ì–∞ —Ä–∞—Ö–º–µ—Ç!\n\n–§–∏–Ω–ì–æ–Ω–∫–∏ - Telegram “õ–æ–ª–¥–∞–Ω–±–∞—Å—ã–Ω—ã“£ –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ–≥—ñ –æ–π—ã–Ω. “ö–∞—Ç—ã—Å—É “Ø—à—ñ–Ω “õ–æ—Å—ã–º—à–∞ —Ñ–∞–π–ª–¥–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ–º–µ—É –Ω–µ–º–µ—Å–µ –±–∞—Å“õ–∞ —Å–∞–π—Ç—Ç–∞—Ä“ì–∞ ”©—Ç—É “õ–∞–∂–µ—Ç –µ–º–µ—Å - –±–∞—Ä–ª—ã“ì—ã –æ“£–∞–π –∂”ô–Ω–µ —Ç–µ–∑! üöÄ\n\n–û–π—ã–Ω ”ô—Ä–µ–∫–µ—Ç—ñ –Ω–µ–≥—ñ–∑–≥—ñ –º–µ–Ω—é–¥–µ–Ω –±–∞—Å—Ç–∞–ª–∞–¥—ã, –º“±–Ω–¥–∞ —Å—ñ–∑ 3 –±”©–ª—ñ–º–Ω—ñ“£ –±—ñ—Ä–µ—É—ñ–Ω–µ ”©—Ç—É—ñ“£—ñ–∑–≥–µ –±–æ–ª–∞–¥—ã:\n1. –ö–∞—Ä—Ç–∞ üó∫\n2. –ì–∞—Ä–∞–∂ üè†\n3. –õ–∏–¥–µ—Ä–ª–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ üèÖ\n\nüìç –ö–∞—Ä—Ç–∞ - –§–∏–Ω–ì–æ–Ω–∫–∞–¥–∞“ì—ã ”ô—Ä–±—ñ—Ä –∂–∞—Ä—ã—Å –±–∞—Å—Ç–∞–ª–∞—Ç—ã–Ω –Ω–µ–≥—ñ–∑–≥—ñ –Ω“Ø–∫—Ç–µ! –ê–π–º–∞“õ—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑ –∂”ô–Ω–µ “õ–∞—Ä–∂—ã–ª—ã“õ —Å–∞—É–∞—Ç—Ç—ã–ª—ã“õ ”ô–ª–µ–º—ñ–Ω–µ –±“±—Ä—ã–ª—ã“£—ã–∑! –ö–µ–π—ñ–Ω —Å—ñ–∑ –ø–∞–π–¥–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç–ø–µ–Ω “õ—ã—Å“õ–∞ —Ç–µ–æ—Ä–∏—è–ª—ã“õ –±–ª–æ–∫ –∫“Ø—Ç–µ–¥—ñ, —Ç–µ–∫ —Å–æ–¥–∞–Ω –∫–µ–π—ñ–Ω –Ω–∞“ì—ã–∑ –∂–∞—Ä—ã—Å –±–∞—Å—Ç–∞–ª–∞–¥—ã! ”®—Ç–∫–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª –±–æ–π—ã–Ω—à–∞ —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä“ì–∞ —Ç–µ–∑—ñ—Ä–µ–∫ –∂”ô–Ω–µ –¥“±—Ä—ã—Å –∂–∞—É–∞–ø –±–µ—Ä—Å–µ“£—ñ–∑, —Å—ñ–∑–¥—ñ“£ –∞–≤—Ç–æ–∫”©–ª—ñ–≥—ñ“£—ñ–∑ —Ç–µ–∑—ñ—Ä–µ–∫ –∂“Ø—Ä–µ–¥—ñ! –ï—Å–∫–µ—Ä—ñ“£—ñ–∑ –∂”ô–Ω–µ “õ–∞—Ä—Å—ã–ª–∞—Å—Ç—ã“£ —Å—ñ–∑–¥—ñ –∞—Å—ã–ø —Ç“Ø—Å—É–≥–µ –º“Ø–º–∫—ñ–Ω–¥—ñ–∫ –±–µ—Ä–º–µ“£—ñ–∑! ”ò—Ä–±—ñ—Ä –∂–µ“£—ñ—Å “õ–∞—Ä–∂—ã–ª—ã“õ –∂“Ø–ª–¥–µ –∂”ô–Ω–µ –¥–∞“£“õ “±–ø–∞–π–ª–∞—Ä—ã–Ω ”ô–∫–µ–ª–µ–¥—ñ üèÜ\n\nüìç –ì–∞—Ä–∞–∂ - –±–∞—Ä–ª—ã“õ –∞–≤—Ç–æ–∫”©–ª—ñ–∫—Ç–µ—Ä—ñ“£—ñ–∑ –æ—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä (–±–∞—Ä–ª—ã“ì—ã —Ç—ñ—Ä—ñ–ª—ñ–∫—Ç–µ–≥—ñ–¥–µ–π!). –ú“±–Ω–¥–∞ —Å—ñ–∑ –∂–∞“£–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç—ã —Ç–∞“£–¥–∞—É“ì–∞ –Ω–µ–º–µ—Å–µ ”ô–∑—ñ—Ä –±–∞—Ä—É—à—ã–Ω—ã –∂–∞“õ—Å–∞—Ä—Ç—É“ì–∞ –±–æ–ª–∞–¥—ã. ”®–∑—ñ“£—ñ–∑–¥—ñ“£ “õ–∞—Ä–∞–∂–∞—Ç—ã“£—ã–∑–¥—ã –∞“õ—ã–ª–º–µ–Ω –ø–∞–π–¥–∞–ª–∞–Ω—ã“£—ã–∑!\n\nüìç –õ–∏–¥–µ—Ä–ª–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ - –º“±–Ω–¥–∞ —Å—ñ–∑ ”©–∑—ñ“£—ñ–∑–¥—ñ“£ —Ä–µ–π—Ç–∏–Ω–≥—Ç–µ–≥—ñ –æ—Ä–Ω—ã“£—ã–∑–¥—ã –∫”©—Ä—É—ñ“£—ñ–∑–≥–µ, –¥–æ—Å—Ç—ã“£—ã–∑–±–µ–Ω —Å–∞–ª—ã—Å—Ç—ã—Ä—É—ã“£—ã–∑“ì–∞ –∂”ô–Ω–µ –∂–µ“£—ñ—Å—Ç–µ—Ä—ñ“£—ñ–∑–±–µ–Ω –ª”ô–∑–∑–∞—Ç—Ç–∞–Ω—É—ã“£—ã–∑“ì–∞ –±–æ–ª–∞–¥—ã!\n\n–ü–æ–µ—Ö–∞–ª–∏? üèéüèé`;
        startGameLabel = '–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É üïπ';
        rulesLabel = '–ï—Ä–µ–∂–µ–ª–µ—Ä üìú';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await bot.sendMessage(chatId, firstMessage, {
        parseMode: 'Markdown',
        replyMarkup: bot.inlineKeyboard([
            [bot.inlineButton(startGameLabel, { url: 'https://racingapp.devnullteam.ru' })],
            [bot.inlineButton(rulesLabel, { callback: 'show_rules' })],
        ])
    });}
    if (msg.data === 'show_rules') {
      const chatId = msg.message.chat.id;
      const rulesMessage = users[chatId];

      if (rulesMessage) {
        await bot.sendMessage(chatId, rulesMessage, {
          parseMode: 'Markdown',
          replyMarkup: bot.inlineKeyboard([
              [bot.inlineButton(startGameLabel, { url: 'https://racingapp.devnullteam.ru' })],
          ])
      });
        await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—á–∏—Ç–∞–ª –ø—Ä–∞–≤–∏–ª–∞');;
      } else {
          await bot.sendMessage(chatId, '–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
      }
  }
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    users[chatId] = rulesMessage;
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /on –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI
bot.on('/on', async (msg) => {
    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'there';

    let startMessage = '';
    if (selectedLanguageMain === 'ru') {
        startMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã
–Ø - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ú–∏—Ç–∞! üíº
–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω—å–≥–∞–º–∏.

üîß –ö–æ–º–∞–Ω–¥—ã:
/on ‚Äî –í–∫–ª—é—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã AI
/off ‚Äî –û—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã AI
/clear ‚Äî –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
/history ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

–ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é? üòä`;
    } else if (selectedLanguageMain === 'be') {
        startMessage = `–ü—Ä—ã–≤—ñ—Ç–∞–Ω—å–Ω–µ, ${firstName}! üëã
–Ø - —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã –ø–∞–º–æ—á–Ω—ñ–∫ –ú—ñ—Ç–∞! üíº
–Ø –¥–∞–ø–∞–º–æ–≥—É —Ç–∞–±–µ –∑ –ø—ã—Ç–∞–Ω–Ω—è–º—ñ –∞—Å–∞–±—ñ—Å—Ç—ã—Ö —Ñ—ñ–Ω–∞–Ω—Å–∞—û, –±—é–¥–∂—ç—Ç–∞–≤–∞–Ω–Ω—è —ñ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è –≥—Ä–∞—à—ã–º–∞.

üîß –ö–∞–º–∞–Ω–¥—ã:
/on ‚Äî –£–∫–ª—é—á—ã—Ü—å –∞–¥–∫–∞–∑—ã AI
/off ‚Äî –í—ã–∫–ª—é—á—ã—Ü—å –∞–¥–∫–∞–∑—ã AI
/clear ‚Äî –ê—á—ã—Å—Ü—ñ—Ü—å –≥—ñ—Å—Ç–æ—Ä—ã—é –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û
/history ‚Äî –ü–∞–∫–∞–∑–∞—Ü—å –≥—ñ—Å—Ç–æ—Ä—ã—é –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û

–ì–æ—Ç—ã –¥–∞ —Å—É–ø—Ä–∞—Ü–æ—û–Ω—ñ—Ü—Ç–≤–∞? üòä`;
    } else if (selectedLanguageMain === 'kk') {
        startMessage = `–°”ô–ª–µ–º, ${firstName}! üëã
–ú–µ–Ω - “õ–∞—Ä–∂—ã–ª—ã“õ –∫”©–º–µ–∫—à—ñ –ú–∏—Ç–∞! üíº
–ú–µ–Ω —Å—ñ–∑–≥–µ –∂–µ–∫–µ “õ–∞—Ä–∂—ã, –±—é–¥–∂–µ—Ç –∂–∞—Å–∞—É –∂”ô–Ω–µ –∞“õ—à–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.

üîß –ö–æ–º–∞–Ω–¥–∞–ª–∞—Ä:
/on ‚Äî AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã–Ω “õ–æ—Å—É
/off ‚Äî AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã–Ω ”©—à—ñ—Ä—É
/clear ‚Äî –•–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã–Ω —Ç–∞–∑–∞–ª–∞—É
/history ‚Äî –•–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã–Ω –∫”©—Ä—Å–µ—Ç—É

–°”©–π–ª–µ—Å—É–≥–µ –¥–∞–π—ã–Ω—Å—ã–∑ –±–∞? üòä`;
    }

    userSettings[chatId] = { aiEnabled: true };
    await bot.sendMessage(chatId, startMessage, { parse_mode: 'Markdown' });
    initializeUserSession(chatId, selectedLanguageMain);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∏–ª –æ—Ç–≤–µ—Ç—ã AI');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /off –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI
bot.on('/off', async (msg) => {
    const chatId = msg.chat.id;
    let offMessage = '';
    if (selectedLanguageMain === 'ru') {
        offMessage = 'ü§ñ –û—Ç–≤–µ—Ç—ã AI –æ—Ç–∫–ª—é—á–µ–Ω—ã! –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!';
    } else if (selectedLanguageMain === 'be') {
        offMessage = 'ü§ñ –ê–¥–∫–∞–∑—ã AI –∞–¥–∫–ª—é—á–∞–Ω—ã! –î–∑—è–∫—É–π –∑–∞ –∑–≤–∞—Ä–æ—Ç!';
    } else if (selectedLanguageMain === 'kk') {
        offMessage = 'ü§ñ AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã ”©—à—ñ—Ä—ñ–ª–¥—ñ! –ö”©—Ä—ñ—Å–∫–µ–Ω—ñ“£—ñ–∑ “Ø—à—ñ–Ω —Ä–∞—Ö–º–µ—Ç!';
    }
    userSettings[chatId] = { aiEnabled: false };
    await bot.sendMessage(chatId, offMessage);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª –æ—Ç–≤–µ—Ç—ã AI');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('/clear', async (msg) => {
    const chatId = msg.chat.id;
    let clearMessage = '';
    if (selectedLanguageMain === 'ru') {
        clearMessage = 'üóë –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞.';
    } else if (selectedLanguageMain === 'be') {
        clearMessage = 'üóë –í–∞—à–∞ –≥—ñ—Å—Ç–æ—Ä—ã—è –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û –±—ã–ª–∞ –∞—á—ã—à—á–∞–Ω–∞.';
    } else if (selectedLanguageMain === 'kk') {
        clearMessage = 'üóë –°—ñ–∑–¥—ñ“£ —Ö–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã“£—ã–∑ —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.';
    }
    clearUserSession(chatId);
    await bot.sendMessage(chatId, clearMessage);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—á–∏—Å—Ç–∏–ª –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /history –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('/history', async (msg) => {
    const chatId = msg.chat.id;
    let noHistoryMessage = '';
    if (selectedLanguageMain === 'ru') {
        noHistoryMessage = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.';
    } else if (selectedLanguageMain === 'be') {
        noHistoryMessage = '–£ –≤–∞—Å –ø–∞–∫—É–ª—å –Ω—è–º–∞ –≥—ñ—Å—Ç–æ—Ä—ã—ñ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û.';
    } else if (selectedLanguageMain === 'kk') {
        noHistoryMessage = '–°—ñ–∑–¥—ñ“£ —Ö–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã“£—ã–∑ ”ô–ª—ñ –∂–æ“õ.';
    }
    if (!userSessions[chatId] || userSessions[chatId].length <= 1) {
        await bot.sendMessage(chatId, noHistoryMessage);
    } else {
        const history = formatHistory(userSessions[chatId]);
        await bot.sendMessage(chatId, `üìù –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:\n\n${history}`);
    }
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg.text;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ –æ—Ç–≤–µ—Ç—ã AI –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π
  if (!userSettings[chatId]?.aiEnabled && !text.startsWith('/')) {
      let aiDisabledMessage = '';
      if (selectedLanguageMain === 'ru') {
          aiDisabledMessage = '‚ö†Ô∏è –û—Ç–≤–µ—Ç—ã AI –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /on, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∏—Ö.';
      } else if (selectedLanguageMain === 'be') {
          aiDisabledMessage = '‚ö†Ô∏è –ê–¥–∫–∞–∑—ã AI –∞–¥–∫–ª—é—á–∞–Ω—ã. –£–≤—è–¥–∑—ñ—Ü–µ /on, –∫–∞–± —É–∫–ª—é—á—ã—Ü—å —ñ—Ö.';
      } else if (selectedLanguageMain === 'kk') {
          aiDisabledMessage = '‚ö†Ô∏è AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω. /on –∂–∞–∑—ã–ø, “õ–æ—Å—É “Ø—à—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.';
      }
      await bot.sendMessage(chatId, aiDisabledMessage);
      return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ù–ï –∫–æ–º–∞–Ω–¥
  if (!text.startsWith('/')) {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (!userSessions[userId]) {
          initializeUserSession(userId, selectedLanguageMain);
      }

      try {
          const userQuery = text;

          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –µ–≥–æ —Å–µ—Å—Å–∏—é
          userSessions[userId].push({ role: 'user', content: userQuery });
          truncateUserMessages(userId);

          // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞
          await logAction(chatId, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏ Mistral...');
          await logAction(chatId, selectedLanguageMain)
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Mistral
          const chatResponse = await client.chat.complete({
              model: 'open-mistral-nemo',
              messages: [
                  userSessions[userId][0], // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                  ...userSessions[userId].slice(-5) // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
              ],
          });

          const botResponse = chatResponse.choices[0].message.content;

          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          userSessions[userId].push({ role: 'assistant', content: botResponse });
          truncateUserMessages(userId);

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          await bot.sendMessage(chatId, botResponse);
          await forwardMessageToAdmin(msg, botResponse);
      } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
          let errorMessage = '';
          if (selectedLanguageMain === 'ru') {
              errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
          } else if (selectedLanguageMain === 'be') {
              errorMessage = '–ê–¥–±—ã–ª–∞—Å—è –ø–∞–º—ã–ª–∫–∞ –ø—Ä—ã –∞–ø—Ä–∞—Ü–æ—û—Ü—ã –≤–∞—à–∞–≥–∞ –∑–∞–ø—ã—Ç—É. –ö–∞–ª—ñ –ª–∞—Å–∫–∞, –ø–∞—Å–ø—Ä–∞–±—É–π—Ü–µ –ø–∞–∑–Ω–µ–π.';
          } else if (selectedLanguageMain === 'kk') {
              errorMessage = '–°—ñ–∑–¥—ñ“£ —Å“±—Ä–∞—É—ã“£—ã–∑–¥—ã ”©“£–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. ”®—Ç—ñ–Ω–µ–º—ñ–∑, –∫–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.';
          }
          await bot.sendMessage(chatId, errorMessage);
      }
      await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ');
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
export default bot;
