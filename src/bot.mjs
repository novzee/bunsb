import TeleBot from 'telebot';
import schedule from 'node-schedule';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const users = new Set();

let startCommandCounter = 0;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.on('/start', async (msg) => {
  startCommandCounter++;
  console.log(`Received /start command. Counter: ${startCommandCounter}`);

  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || 'there';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  users.add(chatId);

  // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
  const firstMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —á—Ç–æ —Ç—ã —Ä–µ—à–∏–ª –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—à—É –Ω–æ–≤—É—é –∏–≥—Ä—É! –û–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –Ω–∞—É—á–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≥–æ–Ω–∫–∏. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –±—É–¥–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø–æ–µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å!\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –£–¥–∞—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤! üöÄüí∞`;

  await bot.sendMessage(chatId, firstMessage, {
    parseMode: 'Markdown',
    replyMarkup: bot.inlineKeyboard([
      [
        bot.inlineButton('–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üïπ', { url: 'https://racingapp.devnullteam.ru' }),
        bot.inlineButton('–ü—Ä–∞–≤–∏–ª–∞ üìú', { callback: '/rules' })
      ]
    ])
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /rules
bot.on('/rules', async (msg) => {
  const chatId = msg.chat.id;

  const rulesMessage = `*–ü–†–ê–í–ò–õ–ê –ò–ì–†–´*\n\n–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º —Ç–µ–±—è –∑–∞ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å!\n–§–∏–Ω–ì–æ–Ω–∫–∏ - –∏–≥—Ä–∞ –Ω–∞ –±–∞–∑–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¢–µ–ª–µ–≥—Ä–∞–º. –ß—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –Ω–µ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã - –≤—Å–µ –ª–µ–≥–∫–æ –∏ –±—ã—Å—Ç—Ä–æ! üöÄ\n\n–î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä—ã –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, –∑–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ–¥–∏–Ω –∏–∑ 3 —Ä–∞–∑–¥–µ–ª–æ–≤:\n1. *–ö–∞—Ä—Ç–∞* üó∫\n2. *–ì–∞—Ä–∞–∂* üè†\n3. *–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤* üèÖ\n\nüìç *–ö–∞—Ä—Ç–∞* ‚Äì –∫–ª—é—á–µ–≤–∞—è —Ç–æ—á–∫–∞, —Å –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª—é–±–æ–π –∑–∞–µ–∑–¥ –≤ –§–∏–Ω–ì–æ–Ω–∫–∞—Ö! –í—ã–±–∏—Ä–∞–π —Ä–∞–π–æ–Ω –∏ –ø–æ–≥—Ä—É–∂–∞–π—Å—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏! –î–∞–ª—å—à–µ —Ç–µ–±—è –∂–¥–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ —Å –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –≥–æ–Ω–∫–∞! –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å! –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∏ –Ω–µ –¥–∞–π —Å–æ–ø–µ—Ä–Ω–∏–∫—É —Å–µ–±—è –æ–±–æ–≥–Ω–∞—Ç—å! –ö–∞–∂–¥–∞—è –ø–æ–±–µ–¥–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –∏ –æ—á–∫–∏ —Å–ª–∞–≤—ã üèÜ\n\nüìç *–ì–∞—Ä–∞–∂* ‚Äì –º–µ—Å—Ç–æ, –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ —Ç–≤–æ–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (–≤—Å–µ –∫–∞–∫ –≤ –∂–∏–∑–Ω–∏!) –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏–ª–∏ –ø—Ä–æ–∫–∞—á–∞—Ç—å —É–∂–µ –∏–º–µ—é—â–∏–π—Å—è. –†–∞—Å–ø–æ—Ä—è–∂–∞–π—Å—è —Å–≤–æ–∏–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —Å —É–º–æ–º!\n\nüìç *–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤* ‚Äì –∑–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ, —Å—Ä–∞–≤–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –ø–æ–±–µ–¥–∞–º–∏!\n\n–ü–æ–µ—Ö–∞–ª–∏? üèéüèé`;

  await bot.sendMessage(chatId, rulesMessage, { parseMode: 'Markdown' });
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ –¥–≤–µ –º–∏–Ω—É—Ç—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
schedule.scheduleJob('*/2 * * * *', async () => {
  for (const chatId of users) {
    try {
      await bot.sendMessage(chatId, '–î–∞–≤–Ω–æ —Ç–µ–±—è –Ω–µ –±—ã–ª–æ –≤ —É–ª–∏—á–Ω—ã—Ö –≥–æ–Ω–∫–∞—Ö! üèéüí®');
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}:`, error);
    }
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.start();
export default bot;
