import TeleBot from 'telebot';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const users = new Set();

let startCommandCounter = 0;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.on('/start', async (msg) => {
  startCommandCounter++;
  console.log(`Received /start command. Counter: ${startCommandCounter}`);

  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || 'there';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  users.add(chatId);
  console.log(`Added user: ${chatId}`);

  // –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
  const languageSelectionMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üéâ\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —è–∑—ã–∫:`;

  await bot.sendMessage(chatId, languageSelectionMessage, {
    parseMode: 'Markdown',
    replyMarkup: bot.inlineKeyboard([
      [bot.inlineButton('–†—É—Å—Å–∫–∏–π üá∑üá∫', { callback: 'ru' })],
      [bot.inlineButton('–ë–µ–ª–∞—Ä—É—Å—Å–∫–∏–π üáßüáæ', { callback: 'be' })],
      [bot.inlineButton('–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π üá∞üáø', { callback: 'kk' })]
    ])
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
bot.on('callbackQuery', async (msg) => {
  const chatId = msg.message.chat.id;
  const selectedLanguage = msg.data;

  let firstMessage = '';
  let rulesMessage = '';
  let startGameLabel = '';
  let rulesLabel = '';

  if (selectedLanguage === 'ru') {
    firstMessage = `–ü—Ä–∏–≤–µ—Ç! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —á—Ç–æ —Ç—ã —Ä–µ—à–∏–ª –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—à—É –Ω–æ–≤—É—é –∏–≥—Ä—É!\n\n–û–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –Ω–∞—É—á–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≥–æ–Ω–∫–∏. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –±—É–¥–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø–æ–µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å!\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –£–¥–∞—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤! üöÄüí∞`;

    rulesMessage = `üìú *–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã –§–∏–Ω–ì–æ–Ω–∫–∏*\n\n–§–∏–Ω–ì–æ–Ω–∫–∏ ‚Äî —ç—Ç–æ –∏–≥—Ä–∞ –Ω–∞ –±–∞–∑–µ Telegram, —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–æ–π ‚Äî –ø–æ–≤—ã—Å–∏—Ç—å —Ç–≤–æ—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –∞–≤—Ç–æ–≥–æ–Ω–∫–∏. –í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:\n\n1. *–ö–∞—Ä—Ç–∞ üó∫*: –ù–∞—á–Ω–∏ –∑–∞–µ–∑–¥, –≤—ã–±—Ä–∞–≤ —Ä–∞–π–æ–Ω –∏ –∏–∑—É—á–∏–≤ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª.\n2. *–ì–∞—Ä–∞–∂ üè†*: –£–ø—Ä–∞–≤–ª—è–π —Å–≤–æ–∏–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ ‚Äî —É–ª—É—á—à–∞–π –∏—Ö –∏–ª–∏ –ø–æ–∫—É–ø–∞–π –Ω–æ–≤—ã–µ.\n3. *–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ üèÖ*: –°—Ä–∞–≤–Ω–∏–≤–∞–π —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –ø–æ–¥–Ω–∏–º–∞–π—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ.\n\n–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –º—á–∞–ª—Å—è –∫ –ø–æ–±–µ–¥–µ! üèéÔ∏èüí®`;

    startGameLabel = '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üïπ';
    rulesLabel = '–ü—Ä–∞–≤–∏–ª–∞ üìú';
  } else if (selectedLanguage === 'be') {
    firstMessage = `–í—ñ—Ç–∞–µ–º! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —à—Ç–æ —Ç—ã –≤—ã—Ä–∞—à—ã—û —Å–ø—Ä–∞–±–∞–≤–∞—Ü—å –Ω–∞—à—É –Ω–æ–≤—É—é –≥—É–ª—å–Ω—é!\n\n–Ø–Ω–∞ —Å—Ç–≤–æ—Ä–∞–Ω–∞ –¥–ª—è —Ç–∞–≥–æ, –∫–∞–± –¥–∞–ø–∞–º–∞–≥—á—ã —Ç–∞–±–µ –≤—ã–≤—É—á—ã—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—É—é –≥—Ä–∞–º–∞—Ç—É —û –∑–∞–π–º–∞–ª—å–Ω—ã–º —Ñ–∞—Ä–º–∞—Ü–µ –≥–æ–Ω–∫—ñ. –ß—ã–º —Ö—É—Ç—á—ç–π —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–µ–π —Ç—ã –±—É–¥–∑–µ—à –∞–¥–∫–∞–∑–≤–∞—Ü—å –Ω–∞ –ø—ã—Ç–∞–Ω–Ω—ñ, —Ç—ã–º —Ö—É—Ç—á—ç–π –ø–∞–µ–¥–∑–µ —Ç–≤–æ–π –∞—û—Ç–∞–º–∞–±—ñ–ª—å!\n\n–ö–∞–± –ø–∞—á–∞—Ü—å –≥—É–ª—å–Ω—é, –ø—Ä–æ—Å—Ç–∞ –Ω–∞—Ü—ñ—Å–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω—ñ–∂—ç–π. –£–¥–∞—á—ã —ñ –ø—Ä—ã–µ–º–Ω–∞–≥–∞ –ø–∞–¥–∞—Ä–æ–∂–∂–∞ —û —Å–≤–µ—Ç —Ñ—ñ–Ω–∞–Ω—Å–∞—û! üöÄüí∞`;

    rulesMessage = `üìú *–ü—Ä–∞–≤—ñ–ª—ã –≥—É–ª—å–Ω—ñ –§—ñ–Ω–ì–æ–Ω–∫—ñ*\n\n–§—ñ–Ω–ì–æ–Ω–∫—ñ ‚Äî –≥—ç—Ç–∞ –≥—É–ª—å–Ω—è –Ω–∞ –∞—Å–Ω–æ–≤–µ Telegram, –º—ç—Ç–∞–π —è–∫–æ–π –∑'—è—û–ª—è–µ—Ü—Ü–∞ –ø–∞–≤—ã—à—ç–Ω–Ω–µ —Ñ—ñ–Ω–∞–Ω—Å–∞–≤–∞–π –≥—Ä–∞–º–∞—Ç–Ω–∞—Å—Ü—ñ –ø—Ä–∞–∑ –∑–∞—Ö–∞–ø–ª—è–ª—å–Ω—ã—è –≥–æ–Ω–∫—ñ. –ê—Å–Ω–æ—û–Ω—ã—è –º–æ–º–∞–Ω—Ç—ã:\n\n1. *–ö–∞—Ä—Ç–∞ üó∫*: –ü–∞—á–Ω—ñ –≥–æ–Ω–∫—É, –≤—ã–±—Ä–∞—û—à—ã —Ä–∞—ë–Ω —ñ –≤—ã–≤—É—á—ã—û—à—ã —Ç—ç–∞—Ä—ç—Ç—ã—á–Ω—ã –º–∞—Ç—ç—Ä—ã—è–ª.\n2. *–ì–∞—Ä–∞–∂ üè†*: –ö—ñ—Ä—É–π —Å–≤–∞—ñ–º—ñ –∞—û—Ç–∞–º–∞–±—ñ–ª—è–º—ñ ‚Äî –ø–∞–ª—è–ø—à–∞–π —ñ—Ö –∞–±–æ –Ω–∞–±—ã–≤–∞–π –Ω–æ–≤—ã—è.\n3. *–¢–∞–±–ª—ñ—Ü–∞ –ª—ñ–¥–∞—Ä–∞—û üèÖ*: –ü–∞—Ä–∞—û–Ω–æ—û–≤–∞–π —Å–≤–∞–µ –¥–∞—Å—è–≥–Ω–µ–Ω–Ω—ñ –∑ —ñ–Ω—à—ã–º—ñ —û–¥–∑–µ–ª—å–Ω—ñ–∫–∞–º—ñ —ñ –ø–∞–¥—ã–º–∞–π—Å—è —û —Ä—ç–π—Ç—ã–Ω–≥—É.\n\n–ê–¥–∫–∞–∑–≤–∞–π –Ω–∞ –ø—ã—Ç–∞–Ω–Ω—ñ —Ö—É—Ç–∫–∞ —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–∞, –∫–∞–± —Ç–≤–æ–π –∞—û—Ç–∞–º–∞–±—ñ–ª—å —ñ–º—á–∞—û—Å—è –¥–∞ –ø–µ—Ä–∞–º–æ–≥—ñ! üèéÔ∏èüí®`;

    startGameLabel = '–ü–∞—á–∞—Ü—å –≥—É–ª—å–Ω—é üïπ';
    rulesLabel = '–ü—Ä–∞–≤—ñ–ª—ã üìú';
  } else if (selectedLanguage === 'kk') {
    firstMessage = `–°”ô–ª–µ–º! üéâ\n\n–ë—ñ–∑ —Å—ñ–∑–¥—ñ“£ –∂–∞“£–∞ –æ–π—ã–Ω—ã–º—ã–∑–¥—ã —Å—ã–Ω–∞–ø –∫”©—Ä—É —à–µ—à—ñ–º—ñ“£—ñ–∑–≥–µ “õ—É–∞–Ω—ã—à—Ç—ã–º—ã–∑!\n\n–û–π—ã–Ω —Å—ñ–∑–≥–µ “õ–∞—Ä–∂—ã–ª—ã“õ —Å–∞—É–∞—Ç—Ç—ã–ª—ã“õ—Ç—ã –∞–≤—Ç–æ–∂–∞—Ä—ã—Å —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ “Ø–π—Ä–µ–Ω—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–¥—ñ. –°“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂—ã–ª–¥–∞–º ”ô—Ä—ñ –¥“±—Ä—ã—Å –∂–∞—É–∞–ø –±–µ—Ä—Å–µ“£—ñ–∑, —Å—ñ–∑–¥—ñ“£ –∫”©–ª—ñ–≥—ñ“£—ñ–∑ –∂—ã–ª–¥–∞–º—ã—Ä–∞“õ –∂“Ø—Ä–µ–¥—ñ!\n\n–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç”©–º–µ–Ω–¥–µ–≥—ñ –±–∞—Ç—ã—Ä–º–∞–Ω—ã –±–∞—Å—ã“£—ã–∑. “ö–∞—Ä–∂—ã ”ô–ª–µ–º—ñ–Ω–¥–µ —Å”ô—Ç—Ç—ñ —Å–∞–ø–∞—Ä —Ç—ñ–ª–µ–π–º—ñ–∑! üöÄüí∞`;

    rulesMessage = `üìú *–§–∏–Ω–ì–æ–Ω–∫–∏ –æ–π—ã–Ω—ã–Ω—ã“£ –µ—Ä–µ–∂–µ–ª–µ—Ä—ñ*\n\n–§–∏–Ω–ì–æ–Ω–∫–∏ ‚Äî –±“±–ª Telegram –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ–≥—ñ –æ–π—ã–Ω, –æ–Ω—ã“£ –º–∞“õ—Å–∞—Ç—ã ‚Äî “õ—ã–∑—ã“õ—Ç—ã –∂–∞—Ä—ã—Å—Ç–∞—Ä –∞—Ä“õ—ã–ª—ã “õ–∞—Ä–∂—ã–ª—ã“õ —Å–∞—É–∞—Ç—Ç—ã–ª—ã“õ—Ç—ã –∞—Ä—Ç—Ç—ã—Ä—É. –ù–µ–≥—ñ–∑–≥—ñ –±”©–ª—ñ–º–¥–µ—Ä:\n\n1. *–ö–∞—Ä—Ç–∞ üó∫*: –ê–π–º–∞“õ—Ç—ã —Ç–∞“£–¥–∞–ø, —Ç–µ–æ—Ä–∏—è–ª—ã“õ –±”©–ª—ñ–º–Ω–µ–Ω ”©—Ç—ñ–ø, –∂–∞—Ä—ã—Å—Ç—ã –±–∞—Å—Ç–∞“£—ã–∑.\n2. *–ì–∞—Ä–∞–∂ üè†*: –ö”©–ª—ñ–∫—Ç–µ—Ä—ñ“£—ñ–∑–¥—ñ –±–∞—Å“õ–∞—Ä—ã“£—ã–∑ ‚Äî –∂–∞“£–∞—Å—ã–Ω —Å–∞—Ç—ã–ø –∞–ª—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ –±–∞—Ä—ã–Ω –∂–∞“õ—Å–∞—Ä—Ç—ã“£—ã–∑.\n3. *–õ–∏–¥–µ—Ä–ª–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ üèÖ*: ”®–∑ –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä—ñ“£—ñ–∑–¥—ñ –±–∞—Å“õ–∞–ª–∞—Ä–º–µ–Ω —Å–∞–ª—ã—Å—Ç—ã—Ä—ã–ø, —Ä–µ–π—Ç–∏–Ω–≥—Ç–µ –∂–æ“ì–∞—Ä—ã–ª–∞“£—ã–∑.\n\n–°“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂—ã–ª–¥–∞–º ”ô—Ä—ñ –¥“±—Ä—ã—Å –∂–∞—É–∞–ø –±–µ—Ä—ñ–ø, –∂–µ“£—ñ—Å–∫–µ –∂–µ—Ç—ñ“£—ñ–∑! üèéÔ∏èüí®`;

    startGameLabel = '–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É üïπ';
    rulesLabel = '–ï—Ä–µ–∂–µ–ª–µ—Ä üìú';
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
  await bot.sendMessage(chatId, firstMessage, {
    parseMode: 'Markdown',
    replyMarkup: bot.inlineKeyboard([
      [bot.inlineButton(startGameLabel, { url: 'https://racingapp.devnullteam.ru' })],
      [bot.inlineButton(rulesLabel, { callback: 'show_rules' })]
    ])
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  users[chatId] = rulesMessage;
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∞–≤–∏–ª–∞"
bot.on('callbackQuery', async (msg) => {
  if (msg.data === 'show_rules') {
    const chatId = msg.message.chat.id;
    const rulesMessage = users[chatId];

    if (rulesMessage) {
      await bot.sendMessage(chatId, rulesMessage, { parseMode: 'Markdown' });
    } else {
      await bot.sendMessage(chatId, '–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
    }
  }
});

export default bot;
