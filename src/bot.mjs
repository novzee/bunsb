import TeleBot from 'telebot';
import schedule from 'node-schedule';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const users = new Set();

let startCommandCounter = 0;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.on('/start', async (msg) => {
  startCommandCounter++;
  console.log(`Received /start command. Counter: ${startCommandCounter}`);

  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || 'there';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  users.add(chatId);

  // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
  const firstMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üéâ\n\n–ú—ã —Ä–∞–¥—ã, —á—Ç–æ —Ç—ã —Ä–µ—à–∏–ª –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—à—É –Ω–æ–≤—É—é –∏–≥—Ä—É! –û–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –Ω–∞—É—á–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≥–æ–Ω–∫–∏. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ç—ã –±—É–¥–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø–æ–µ–¥–µ—Ç —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å!\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –£–¥–∞—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ –º–∏—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤! üöÄüí∞`;

  await bot.sendMessage(chatId, firstMessage, {
    parseMode: 'Markdown',
    replyMarkup: bot.keyboard([
      ['–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üïπ', '–ü—Ä–∞–≤–∏–ª–∞ üìú']
    ], { resize: true })
  });
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ –¥–≤–∞ —á–∞—Å–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
schedule.scheduleJob('0 */2 * * *', async () => {
  for (const chatId of users) {
    try {
      await bot.sendMessage(chatId, '–î–∞–≤–Ω–æ —Ç–µ–±—è –Ω–µ –±—ã–ª–æ –≤ —É–ª–∏—á–Ω—ã—Ö –≥–æ–Ω–∫–∞—Ö! üèéüí®');
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}:`, error);
    }
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.start();
export default bot;
