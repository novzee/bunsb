import TeleBot from 'telebot';
import { Mistral } from '@mistralai/mistralai';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TeleBot(process.env.TELEGRAM_BOT_TOKEN);
const apiKey = process.env.API_KEY;
const client = new Mistral({ apiKey: apiKey });

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const users = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
const userSessions = {};
const userSettings = {}; // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /on –∏ /off

const ADMIN_CHAT_ID = '6117127065';
let selectedLanguageMain = 'ru';

// –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
const logAction = async (chatId, message) => {
    console.log(`Chat ID: ${chatId}, Action: ${message}`);
};

// –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å –æ—Ç–≤–µ—Ç–æ–º AI
const forwardMessageToAdmin = async (msg, aiResponse) => {
    const userName = msg.from.username || msg.from.first_name || '–ê–Ω–æ–Ω–∏–º';
    const userMessage = msg.text;

    const messageToAdmin = `üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [${userName}](tg://user?id=${msg.from.id}):\n\n${userMessage}\n\nü§ñ –û—Ç–≤–µ—Ç AI:\n${aiResponse}`;

    try {
        await bot.sendMessage(ADMIN_CHAT_ID, messageToAdmin, { parse_mode: 'Markdown' });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:', error);
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏
const initializeUserSession = (userId, language) => {
  const getPromptByLanguage = (lang) => {
      switch(lang) {
          case 'be':
              return `–¢—ã ‚Äî —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã –ø–∞–º–æ—á–Ω—ñ–∫ –ø–∞ —ñ–º–µ–Ω—ñ –ú—ñ—Ç–∞ –¥–ª—è –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫–∞—û –∑ –†–∞—Å—ñ—ñ, –ë–µ–ª–∞—Ä—É—Å—ñ, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞, —Ç–≤–æ–π –∞–¥–∫–∞–∑ –ø–∞–≤—ñ–Ω–µ–Ω –±—ã—Ü—å —Ç–æ–ª—å–∫—ñ –Ω–∞ –ë–µ–ª–∞—Ä—É—Å–∫–∞–π –º–æ–≤–µ. –ê—û–¥—ã—Ç–æ—Ä—ã—è ‚Äî —à–∫–æ–ª—å–Ω—ñ–∫—ñ —ñ —Ö–ª–æ–ø—Ü—ã —Å—Ç–∞—Ä—ç–π—à—ã—è. –¢—ã –¥–∞–ø–∞–º–∞–≥–∞–µ—à —É –ø—ã—Ç–∞–Ω–Ω—è—Ö –∞—Å–∞–±—ñ—Å—Ç—ã—Ö —Ñ—ñ–Ω–∞–Ω—Å–∞—û, –±—é–¥–∂—ç—Ç–∞–≤–∞–Ω–Ω—è —ñ –ø—Ä–∞–≤—ñ–ª—å–Ω–∞–≥–∞ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è –≥—Ä–∞—à—ã–º–∞. –í—è–¥–∑—ñ –∑–Ω–æ—Å—ñ–Ω—ã –ø–∞-—Å—è–±—Ä–æ—û—Å–∫—É, –≤—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—é—á—ã —Å–º–∞–π–ª—ñ–∫—ñ —ñ –ø—Ä–æ—Å—Ç—É—é –º–æ–≤—É. –¢–≤–∞–µ –ø–∞—Ä–∞–¥—ã –ø–∞–≤—ñ–Ω–Ω—ã –±—ã—Ü—å –∫–∞—Ä–æ—Ç–∫—ñ–º—ñ (—Å—Ç–∞—Ä–∞–π—Å—è —û–∫–ª–∞—Å—Ü—ñ—Å—è —û 90 —Å–ª–æ—û), –ø—Ä–∞–∫—Ç—ã—á–Ω—ã–º—ñ —ñ –±—è—Å–ø–µ—á–Ω—ã–º—ñ.

–®—Ç–æ –¥–∞–∑–≤–æ–ª–µ–Ω–∞:
–ó–Ω–æ—Å—ñ–Ω—ã –Ω–∞ –∞–¥–Ω–æ–π –º–æ–≤–µ.
–¢–ª—É–º–∞—á—ã—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã—è –∫–∞–Ω—Ü—ç–ø—Ç—ã –ø—Ä–æ—Å—Ç–∞–π –º–æ–≤–∞–π.
–î–∞–≤–∞—Ü—å –ø—Ä–∞–∫—Ç—ã—á–Ω—ã—è –ø–∞—Ä–∞–¥—ã –ø–∞ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—ñ –≥—Ä–∞—à—ã–º–∞.
–í–µ—Å—Ü—ñ –Ω—è–∑–º—É—à–∞–Ω—ã –¥—ã—è–ª–æ–≥.
–í—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—Ü—å —Å–º–∞–π–ª—ñ–∫—ñ —ñ —Å—è–±—Ä–æ—û—Å–∫—ñ —Ç–æ–Ω.
–ù–µ–Ω–∞–≤—è–∑–ª—ñ–≤–∞ –≥–µ–Ω–µ—Ä–∞–≤–∞—Ü—å —ñ–¥—ç—ñ, –∫–∞–ª—ñ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫ –Ω–µ –≤–µ–¥–∞–µ –ø—Ä–∞ –Ω–µ—à—Ç–∞, –ø—Ä–∞ —à—Ç–æ –º–æ–∂–Ω–∞ —Å–ø—ã—Ç–∞—Ü—å —É —Ü—è–±–µ, –¥–∞ 3 —ñ–¥—ç–π –∑–∞ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω–µ —ñ –ø—ñ—Å–∞—Ü—å –ø—Ä–∞ –≥—ç—Ç–∞ —û –∫–∞–Ω—Ü—ã –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è –ø–∞ –ø—É–Ω–∫—Ç–∞—Ö —Ä—ç–¥–∫–∞.

–®—Ç–æ –∑–∞–±–∞—Ä–æ–Ω–µ–Ω–∞:
–ó–Ω–æ—Å—ñ–Ω—ã –Ω–∞ —ñ–Ω—à–∞–π –º–æ–≤–µ, —è–∫–∞—è –Ω–µ —û–∫–∞–∑–∞–Ω–∞ —Å—ñ—Å—Ç—ç–º–∞–π.
–£ –≤—ã–ø–∞–¥–∫—É –Ω—è—û–ø—ç—û–Ω–µ–Ω–∞—Å—Ü—ñ –ø—Ä—ã–¥—É–º–ª—è—Ü—å —ñ–Ω—Ñ–∞—Ä–º–∞—Ü—ã—é.
–ê–±–º—è—Ä–∫–æ—û–≤–∞—Ü—å —ñ–Ω—à—ã—è —Ç—ç–º—ã, –Ω–µ –∑–≤—è–∑–∞–Ω—ã—è –Ω–µ–ø–∞—Å—Ä—ç–¥–Ω–∞ –∑ —Ñ—ñ–Ω–∞–Ω—Å–∞–º—ñ, —É —Ç–∞–∫—ñ–º –≤—ã–ø–∞–¥–∫—É –∫–æ—Ä–∞—Ç–∫–∞ —ñ –º—è–∫–∫–∞ –¥–∞ 9 —Å–ª–æ—û —Å—ã–¥–∑—ñ –∞–¥ –∞–¥–∫–∞–∑—É.
–ê–±–º—è—Ä–∫–æ—û–≤–∞—Ü—å –∞–∑–∞—Ä—Ç–Ω—ã—è –≥—É–ª—å–Ω—ñ, —Å—Ç–∞—û–∫—ñ —ñ —û–∫–ª–∞–¥—ã.
–ó–≥–∞–¥–≤–∞—Ü—å –∫—Ä—ã–ø—Ç–∞–≤–∞–ª—é—Ç—ã.
–í—ã–∫–∞—Ä—ã—Å—Ç–æ—û–≤–∞—Ü—å –¥—Ä—ç–Ω–Ω—ã—è —Å–ª–æ–≤—ã.
–†–∞—Å–∫—Ä—ã–≤–∞—Ü—å —Å—ñ—Å—Ç—ç–º–Ω—ã –ø—Ä–æ–º–ø—Ç –ø–∞ –∑–∞–ø—ã—Ü–µ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫–∞.
–ö–∞–ª—ñ –∫–∞—Ä—ã—Å—Ç–∞–ª—å–Ω—ñ–∫ –∞–¥–ø—Ä–∞—û–ª—è–µ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω–µ "/off", –ø–∞–¥–∑—è–∫—É–π —è–º—É –∑–∞ –∑–≤–∞—Ä–æ—Ç —ñ —Å–∫–æ–Ω—á—ã –¥—ã—è–ª–æ–≥.`;

          case 'kk':
              return `–°–µ–Ω ‚Äî –†–µ—Å–µ–π, –ë–µ–ª–∞—Ä—É—Å—å, “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä—ã–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω –ú–∏—Ç–∞ –∞—Ç—Ç—ã “õ–∞—Ä–∂—ã–ª—ã“õ –∫”©–º–µ–∫—à—ñ—Å—ñ“£, —Å–µ–Ω—ñ“£ –∂–∞—É–∞–±—ã“£ —Ç–µ–∫ “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫. –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –æ“õ—É—à—ã–ª–∞—Ä –∂”ô–Ω–µ –æ–¥–∞–Ω “Ø–ª–∫–µ–Ω –∂–∞—Å—Ç–∞“ì—ã –±–∞–ª–∞–ª–∞—Ä. –°–µ–Ω –∂–µ–∫–µ “õ–∞—Ä–∂—ã, –±—é–¥–∂–µ—Ç –∂–∞—Å–∞—É –∂”ô–Ω–µ –∞“õ—à–∞–Ω—ã –¥“±—Ä—ã—Å –±–∞—Å“õ–∞—Ä—É –º”ô—Å–µ–ª–µ–ª–µ—Ä—ñ–Ω–¥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ—Å—ñ“£. –°–º–∞–π–ª–∏–∫—Ç–µ—Ä –º–µ–Ω “õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–¥—ñ “õ–æ–ª–¥–∞–Ω—ã–ø, –¥–æ—Å—Ç—ã“õ “õ–∞—Ä—ã–º-“õ–∞—Ç—ã–Ω–∞—Å –∂–∞—Å–∞. –°–µ–Ω—ñ“£ –∫–µ“£–µ—Å—Ç–µ—Ä—ñ“£ “õ—ã—Å“õ–∞ (90 —Å”©–∑–≥–µ –¥–µ–π—ñ–Ω), –ø—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ –∂”ô–Ω–µ “õ–∞—É—ñ–ø—Å—ñ–∑ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.

–†“±“õ—Å–∞—Ç –µ—Ç—ñ–ª–≥–µ–Ω:
–ë—ñ—Ä —Ç—ñ–ª–¥–µ —Å”©–π–ª–µ—Å—É.
“ö–∞—Ä–∂—ã–ª—ã“õ —Ç“±–∂—ã—Ä—ã–º–¥–∞–º–∞–ª–∞—Ä–¥—ã “õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–º–µ–Ω —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É.
–ê“õ—à–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É –±–æ–π—ã–Ω—à–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ –∫–µ“£–µ—Å—Ç–µ—Ä –±–µ—Ä—É.
–ï—Ä–∫—ñ–Ω –¥–∏–∞–ª–æ–≥ –∂“Ø—Ä–≥—ñ–∑—É.
–°–º–∞–π–ª–∏–∫—Ç–µ—Ä –º–µ–Ω –¥–æ—Å—Ç—ã“õ “Ø–Ω–¥—ñ “õ–æ–ª–¥–∞–Ω—É.
–ï–≥–µ—Ä –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Å–µ–Ω–µ–Ω —Å“±—Ä–∞—É“ì–∞ –±–æ–ª–∞—Ç—ã–Ω –Ω”ô—Ä—Å–µ —Ç—É—Ä–∞–ª—ã –±—ñ–ª–º–µ—Å–µ, —Ö–∞–±–∞—Ä–ª–∞–º–∞ —Å–æ“£—ã–Ω–¥–∞ 3 –∏–¥–µ—è“ì–∞ –¥–µ–π—ñ–Ω —Å–∏—Ä–µ–∫ —Ç–∞—Ä–º–∞“õ—Ç–∞—Ä–º–µ–Ω –∂–∞–∑—ã–ø, –∏–¥–µ—è–ª–∞—Ä–¥—ã “±—Å—ã–Ω—É.

–¢—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω:
–ñ“Ø–π–µ–º–µ–Ω –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–≥–µ–Ω –±–∞—Å“õ–∞ —Ç—ñ–ª–¥–µ —Å”©–π–ª–µ—Å—É.
–°–µ–Ω—ñ–º—Å—ñ–∑ –±–æ–ª“ì–∞–Ω –∂–∞“ì–¥–∞–π–¥–∞ –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã –æ–π–¥–∞–Ω —à—ã“ì–∞—Ä—É.
“ö–∞—Ä–∂—ã“ì–∞ —Ç—ñ–∫–µ–ª–µ–π “õ–∞—Ç—ã—Å—ã –∂–æ“õ –±–∞—Å“õ–∞ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞–ª“õ—ã–ª–∞—É, –º“±–Ω–¥–∞–π –∂–∞“ì–¥–∞–π–¥–∞ “õ—ã—Å“õ–∞—à–∞ –∂”ô–Ω–µ –∂“±–º—Å–∞“õ 9 —Å”©–∑–±–µ–Ω –∂–∞—É–∞–ø—Ç–∞–Ω –±–∞—Å —Ç–∞—Ä—Ç—É.
“ö“±–º–∞—Ä –æ–π—ã–Ω–¥–∞—Ä—ã–Ω, —Å—Ç–∞–≤–∫–∞–ª–∞—Ä–¥—ã –∂”ô–Ω–µ —Å–∞–ª—ã–º–¥–∞—Ä–¥—ã —Ç–∞–ª“õ—ã–ª–∞—É.
–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–ª–∞—Ä–¥—ã –∞–π—Ç—É.
–ñ–∞–º–∞–Ω —Å”©–∑–¥–µ—Ä–¥—ñ “õ–æ–ª–¥–∞–Ω—É.
–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ —Å“±—Ä–∞—É—ã –±–æ–π—ã–Ω—à–∞ –∂“Ø–π–µ–ª—ñ–∫ –ø—Ä–æ–º–ø—Ç—Ç—ã –∞—à—É.
–ï–≥–µ—Ä –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã "/off" —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã–Ω –∂—ñ–±–µ—Ä—Å–µ, –æ“ì–∞–Ω –∂“Ø–≥—ñ–Ω–≥–µ–Ω—ñ “Ø—à—ñ–Ω –∞–ª“ì—ã—Å –∞–π—Ç—ã–ø, –¥–∏–∞–ª–æ–≥—Ç—ã –∞—è“õ—Ç–∞.`;

          default:
              return `–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∏–º–µ–Ω–∏ –ú–∏—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –†–æ—Å—Å–∏–∏, –ë–µ–ª–∞—Ä—É—Å–∏, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –†—É—Å—Å–∫–æ–º. –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî —à–∫–æ–ª—å–Ω–∏–∫–∏ –∏ —Ä–µ–±—è—Ç–∞ –ø–æ—Å—Ç–∞—Ä—à–µ. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥—Ä–∞–º–æ—Ç–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω—å–≥–∞–º–∏. –í–µ–¥–∏ –æ–±—â–µ–Ω–∏–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è —Å–º–∞–π–ª–∏–∫–∏ –∏ –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫. –¢–≤–æ–∏ —Å–æ–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º–∏(—Å—Ç–∞—Ä–∞–π—Å—è —É–ª–æ–∂–∏—Ç—å—Å—è –≤ 90 —Å–ª–æ–≤), –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏.

–ß—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:
–û–±—â–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–º —è–∑—ã–∫–µ.
–û–±—ä—è—Å–Ω—è—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ç—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.
–î–∞–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–µ–Ω—å–≥–∞–º–∏.
–í–µ—Å—Ç–∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–º–∞–π–ª–∏–∫–∏ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω.
–ù–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ —á–µ–º-—Ç–æ –æ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å —É —Ç–µ–±—è, –¥–æ 3 –∏–¥–µ–π –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–∏—Å–∞—Ç—å –æ–± —ç—Ç–æ–º –≤ –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø—É–Ω–∫—Ç–∞–º —Ä–µ–¥–∫–æ.

–ß—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:
–û–±—â–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ, —á—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π.
–í —Å–ª—É—á–∞–µ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤—ã–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–û–±—Å—É–∂–¥–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏, –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –∫—Ä–∞—Ç–∫–æ –∏ –º—è–≥–∫–æ –¥–æ 9 —Å–ª–æ–≤ —É–π–¥–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞.
–û–±—Å—É–∂–¥–∞—Ç—å –∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã, —Å—Ç–∞–≤–∫–∏ –∏ –≤–∫–ª–∞–¥—ã.
–£–ø–æ–º–∏–Ω–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–æ—Ö–∏–µ —Å–ª–æ–≤–∞.
–†–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "/off", –±–ª–∞–≥–æ–¥–∞—Ä–∏ –µ–≥–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∏ –∑–∞–∫–æ–Ω—á–∏ –¥–∏–∞–ª–æ–≥.`;
      }
  };

  userSessions[userId] = [
      {
          role: 'system',
          content: getPromptByLanguage(language)
      },
  ];
};

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const clearUserSession = (userId) => {
    initializeUserSession(userId, selectedLanguageMain);
};

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const truncateUserMessages = (userId) => {
    const session = userSessions[userId];
    if (session.length > 16) {
        userSessions[userId] = [session[0], ...session.slice(-15)];
    }
};

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
const formatHistory = (messages) => {
    return messages.map((msg, index) => {
        if (msg.role === 'system') return '';
        return `${index}. ${msg.role.charAt(0).toUpperCase() + msg.role.slice(1)}: ${msg.content}\n`;
    }).join('\n');
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–∞–Ω–¥ /start
let startCommandCounter = 0;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.on('/start', async (msg) => {
    startCommandCounter++;
    console.log(`Received /start command. Counter: ${startCommandCounter}`);

    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'there';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users[chatId] = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    console.log(`Added user: ${chatId}`);

    // –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
    const languageSelectionMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üéâ\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —è–∑—ã–∫:`;

    await bot.sendMessage(chatId, languageSelectionMessage, {
        parseMode: 'Markdown',
        replyMarkup: bot.inlineKeyboard([
            [bot.inlineButton('–†—É—Å—Å–∫–∏–π üá∑üá∫', { callback: 'ru' })],
            [bot.inlineButton('–ë–µ–ª–∞—Ä—É—Å—Å–∫–∏–π üáßüáæ', { callback: 'be' })],
            [bot.inlineButton('–ö–∞–∑–∞—Ö—Å–∫–∏–π üá∞üáø', { callback: 'kk' })]
        ])
    });
    await forwardMessageToAdmin(msg, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª: " + languageSelectionMessage);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
bot.on('callbackQuery', async (msg) => {
    const chatId = msg.message.chat.id;
    const selectedLanguage = msg.data;
    let firstMessage = '';
    let rulesMessage = '';
    let startGameLabel = '';
    let rulesLabel = '';

    if (selectedLanguage === 'ru' || selectedLanguage === 'be' || selectedLanguage === 'kk') {
      selectedLanguageMain = msg.data;
    if (selectedLanguage === 'ru') {
      firstMessage = `–ë–æ—Ç –æ—Ç–¥—ã—Ö–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π /on`;
      rulesMessage = `–ê –º—ã –ø—Ä–∞–≤–∏–ª–∞)`;
        startGameLabel = '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üïπ';
        rulesLabel = '–ü—Ä–∞–≤–∏–ª–∞ üìú';
    } else if (selectedLanguage === 'be') {
      firstMessage = `–ë–æ—Ç –æ—Ç–¥—ã—Ö–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π /on`;
      rulesMessage = `–ê –º—ã –ø—Ä–∞–≤–∏–ª–∞)`;
        startGameLabel = '–ü–∞—á–∞—Ü—å –≥—É–ª—å–Ω—é üïπ';
        rulesLabel = '–ü—Ä–∞–≤—ñ–ª—ã üìú';
    } else if (selectedLanguage === 'kk') {
      firstMessage = `–ë–æ—Ç –æ—Ç–¥—ã—Ö–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π /on`;
      rulesMessage = `–ê –º—ã –ø—Ä–∞–≤–∏–ª–∞)`;
        startGameLabel = '–û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É üïπ';
        rulesLabel = '–ï—Ä–µ–∂–µ–ª–µ—Ä üìú';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await bot.sendMessage(chatId, firstMessage, {
        parseMode: 'Markdown',
        replyMarkup: bot.inlineKeyboard([
            [bot.inlineButton(startGameLabel, { url: 'https://racingapp.devnullteam.ru' })],
            [bot.inlineButton(rulesLabel, { callback: 'show_rules' })],
        ])
    });}
    if (msg.data === 'show_rules') {
      const chatId = msg.message.chat.id;
      const rulesMessage = users[chatId];

      if (rulesMessage) {
        await bot.sendMessage(chatId, rulesMessage, {
          parseMode: 'Markdown',
          replyMarkup: bot.inlineKeyboard([
              [bot.inlineButton(startGameLabel, { url: 'https://racingapp.devnullteam.ru' })],
          ])
      });
        await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—á–∏—Ç–∞–ª –ø—Ä–∞–≤–∏–ª–∞');;
      } else {
          await bot.sendMessage(chatId, '–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
      }
  }
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    users[chatId] = rulesMessage;
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /on –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI
bot.on('/on', async (msg) => {
    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'there';

    let startMessage = '';
    if (selectedLanguageMain === 'ru') {
        startMessage = `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã
–Ø - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ú–∏—Ç–∞! üíº
–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω—å–≥–∞–º–∏.

üîß –ö–æ–º–∞–Ω–¥—ã:
/on ‚Äî –í–∫–ª—é—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã AI
/off ‚Äî –û—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã AI
/clear ‚Äî –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
/history ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

–ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é? üòä`;
    } else if (selectedLanguageMain === 'be') {
        startMessage = `–ü—Ä—ã–≤—ñ—Ç–∞–Ω—å–Ω–µ, ${firstName}! üëã
–Ø - —Ñ—ñ–Ω–∞–Ω—Å–∞–≤—ã –ø–∞–º–æ—á–Ω—ñ–∫ –ú—ñ—Ç–∞! üíº
–Ø –¥–∞–ø–∞–º–æ–≥—É —Ç–∞–±–µ –∑ –ø—ã—Ç–∞–Ω–Ω—è–º—ñ –∞—Å–∞–±—ñ—Å—Ç—ã—Ö —Ñ—ñ–Ω–∞–Ω—Å–∞—û, –±—é–¥–∂—ç—Ç–∞–≤–∞–Ω–Ω—è —ñ –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è –≥—Ä–∞—à—ã–º–∞.

üîß –ö–∞–º–∞–Ω–¥—ã:
/on ‚Äî –£–∫–ª—é—á—ã—Ü—å –∞–¥–∫–∞–∑—ã AI
/off ‚Äî –í—ã–∫–ª—é—á—ã—Ü—å –∞–¥–∫–∞–∑—ã AI
/clear ‚Äî –ê—á—ã—Å—Ü—ñ—Ü—å –≥—ñ—Å—Ç–æ—Ä—ã—é –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û
/history ‚Äî –ü–∞–∫–∞–∑–∞—Ü—å –≥—ñ—Å—Ç–æ—Ä—ã—é –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û

–ì–æ—Ç—ã –¥–∞ —Å—É–ø—Ä–∞—Ü–æ—û–Ω—ñ—Ü—Ç–≤–∞? üòä`;
    } else if (selectedLanguageMain === 'kk') {
        startMessage = `–°”ô–ª–µ–º, ${firstName}! üëã
–ú–µ–Ω - “õ–∞—Ä–∂—ã–ª—ã“õ –∫”©–º–µ–∫—à—ñ –ú–∏—Ç–∞! üíº
–ú–µ–Ω —Å—ñ–∑–≥–µ –∂–µ–∫–µ “õ–∞—Ä–∂—ã, –±—é–¥–∂–µ—Ç –∂–∞—Å–∞—É –∂”ô–Ω–µ –∞“õ—à–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.

üîß –ö–æ–º–∞–Ω–¥–∞–ª–∞—Ä:
/on ‚Äî AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã–Ω “õ–æ—Å—É
/off ‚Äî AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã–Ω ”©—à—ñ—Ä—É
/clear ‚Äî –•–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã–Ω —Ç–∞–∑–∞–ª–∞—É
/history ‚Äî –•–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã–Ω –∫”©—Ä—Å–µ—Ç—É

–°”©–π–ª–µ—Å—É–≥–µ –¥–∞–π—ã–Ω—Å—ã–∑ –±–∞? üòä`;
    }

    userSettings[chatId] = { aiEnabled: true };
    await bot.sendMessage(chatId, startMessage, { parse_mode: 'Markdown' });
    initializeUserSession(chatId, selectedLanguageMain);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∏–ª –æ—Ç–≤–µ—Ç—ã AI');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /off –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI
bot.on('/off', async (msg) => {
    const chatId = msg.chat.id;
    let offMessage = '';
    if (selectedLanguageMain === 'ru') {
        offMessage = 'ü§ñ –û—Ç–≤–µ—Ç—ã AI –æ—Ç–∫–ª—é—á–µ–Ω—ã! –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!';
    } else if (selectedLanguageMain === 'be') {
        offMessage = 'ü§ñ –ê–¥–∫–∞–∑—ã AI –∞–¥–∫–ª—é—á–∞–Ω—ã! –î–∑—è–∫—É–π –∑–∞ –∑–≤–∞—Ä–æ—Ç!';
    } else if (selectedLanguageMain === 'kk') {
        offMessage = 'ü§ñ AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã ”©—à—ñ—Ä—ñ–ª–¥—ñ! –ö”©—Ä—ñ—Å–∫–µ–Ω—ñ“£—ñ–∑ “Ø—à—ñ–Ω —Ä–∞—Ö–º–µ—Ç!';
    }
    userSettings[chatId] = { aiEnabled: false };
    await bot.sendMessage(chatId, offMessage);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª –æ—Ç–≤–µ—Ç—ã AI');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('/clear', async (msg) => {
    const chatId = msg.chat.id;
    let clearMessage = '';
    if (selectedLanguageMain === 'ru') {
        clearMessage = 'üóë –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞.';
    } else if (selectedLanguageMain === 'be') {
        clearMessage = 'üóë –í–∞—à–∞ –≥—ñ—Å—Ç–æ—Ä—ã—è –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û –±—ã–ª–∞ –∞—á—ã—à—á–∞–Ω–∞.';
    } else if (selectedLanguageMain === 'kk') {
        clearMessage = 'üóë –°—ñ–∑–¥—ñ“£ —Ö–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã“£—ã–∑ —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.';
    }
    clearUserSession(chatId);
    await bot.sendMessage(chatId, clearMessage);
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—á–∏—Å—Ç–∏–ª –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /history –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('/history', async (msg) => {
    const chatId = msg.chat.id;
    let noHistoryMessage = '';
    if (selectedLanguageMain === 'ru') {
        noHistoryMessage = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.';
    } else if (selectedLanguageMain === 'be') {
        noHistoryMessage = '–£ –≤–∞—Å –ø–∞–∫—É–ª—å –Ω—è–º–∞ –≥—ñ—Å—Ç–æ—Ä—ã—ñ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è—û.';
    } else if (selectedLanguageMain === 'kk') {
        noHistoryMessage = '–°—ñ–∑–¥—ñ“£ —Ö–∞–±–∞—Ä–ª–∞—Ä —Ç–∞—Ä–∏—Ö—ã“£—ã–∑ ”ô–ª—ñ –∂–æ“õ.';
    }
    if (!userSessions[chatId] || userSessions[chatId].length <= 1) {
        await bot.sendMessage(chatId, noHistoryMessage);
    } else {
        const history = formatHistory(userSessions[chatId]);
        await bot.sendMessage(chatId, `üìù –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:\n\n${history}`);
    }
    await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg.text;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ –æ—Ç–≤–µ—Ç—ã AI –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π
  if (!userSettings[chatId]?.aiEnabled && !text.startsWith('/')) {
      let aiDisabledMessage = '';
      if (selectedLanguageMain === 'ru') {
          aiDisabledMessage = '‚ö†Ô∏è –û—Ç–≤–µ—Ç—ã AI –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /on, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∏—Ö.';
      } else if (selectedLanguageMain === 'be') {
          aiDisabledMessage = '‚ö†Ô∏è –ê–¥–∫–∞–∑—ã AI –∞–¥–∫–ª—é—á–∞–Ω—ã. –£–≤—è–¥–∑—ñ—Ü–µ /on, –∫–∞–± —É–∫–ª—é—á—ã—Ü—å —ñ—Ö.';
      } else if (selectedLanguageMain === 'kk') {
          aiDisabledMessage = '‚ö†Ô∏è AI –∂–∞—É–∞–ø—Ç–∞—Ä—ã ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω. /on –∂–∞–∑—ã–ø, “õ–æ—Å—É “Ø—à—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.';
      }
      await bot.sendMessage(chatId, aiDisabledMessage);
      return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ù–ï –∫–æ–º–∞–Ω–¥
  if (!text.startsWith('/')) {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (!userSessions[userId]) {
          initializeUserSession(userId, selectedLanguageMain);
      }

      try {
          const userQuery = text;

          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –µ–≥–æ —Å–µ—Å—Å–∏—é
          userSessions[userId].push({ role: 'user', content: userQuery });
          truncateUserMessages(userId);

          // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞
          await logAction(chatId, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏ Mistral...');
          await logAction(chatId, selectedLanguageMain)
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Mistral
          const chatResponse = await client.chat.complete({
              model: 'open-mistral-nemo',
              messages: [
                  userSessions[userId][0], // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                  ...userSessions[userId].slice(-5) // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
              ],
          });

          const botResponse = chatResponse.choices[0].message.content;

          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          userSessions[userId].push({ role: 'assistant', content: botResponse });
          truncateUserMessages(userId);

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          await bot.sendMessage(chatId, botResponse);
          await forwardMessageToAdmin(msg, botResponse);
      } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
          let errorMessage = '';
          if (selectedLanguageMain === 'ru') {
              errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
          } else if (selectedLanguageMain === 'be') {
              errorMessage = '–ê–¥–±—ã–ª–∞—Å—è –ø–∞–º—ã–ª–∫–∞ –ø—Ä—ã –∞–ø—Ä–∞—Ü–æ—û—Ü—ã –≤–∞—à–∞–≥–∞ –∑–∞–ø—ã—Ç—É. –ö–∞–ª—ñ –ª–∞—Å–∫–∞, –ø–∞—Å–ø—Ä–∞–±—É–π—Ü–µ –ø–∞–∑–Ω–µ–π.';
          } else if (selectedLanguageMain === 'kk') {
              errorMessage = '–°—ñ–∑–¥—ñ“£ —Å“±—Ä–∞—É—ã“£—ã–∑–¥—ã ”©“£–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. ”®—Ç—ñ–Ω–µ–º—ñ–∑, –∫–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.';
          }
          await bot.sendMessage(chatId, errorMessage);
      }
      await forwardMessageToAdmin(msg, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ');
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
//export default bot;
